<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç™»å½• - NAS Center</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    .login-container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
      width: 100%;
      max-width: 400px;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .error-message {
      background: #fee;
      color: #c33;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: none;
    }

    .error-message.show {
      display: block;
      animation: shake 0.3s;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <div class="login-container">
    <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-8 text-center">
      <div class="text-5xl mb-3">ğŸš€</div>
      <h1 class="text-2xl font-bold">NAS Center</h1>
      <p class="text-sm opacity-90 mt-2" id="loginTypeText">ä¸»æ§ç®¡ç†ä¸­å¿ƒ</p>
    </div>

    <div class="p-8">
      <div id="errorMessage" class="error-message">
        <span id="errorText">é”™è¯¯ä¿¡æ¯</span>
      </div>

      <form id="loginForm">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ·å</label>
          <input type="text"
                 id="username"
                 required
                 placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition">
        </div>

        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">å¯†ç </label>
          <input type="password"
                 id="password"
                 required
                 placeholder="è¯·è¾“å…¥å¯†ç "
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition">
        </div>

        <button type="submit"
                id="loginButton"
                class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-blue-600 hover:to-purple-700 transition flex items-center justify-center">
          <span id="loginButtonText">ç™»å½•</span>
          <span id="loginLoading" class="loading ml-2" style="display: none;"></span>
        </button>
      </form>
    </div>

    <div class="bg-gray-50 px-8 py-4 text-center text-xs text-gray-500 border-t">
      Â© 2025 NAS Center. All rights reserved.
    </div>
  </div>

  <script>
    axios.defaults.withCredentials = true;
    const apiBaseUrl = 'http://127.0.0.1:8080';

    const loginForm = document.getElementById('loginForm');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginButton = document.getElementById('loginButton');
    const loginButtonText = document.getElementById('loginButtonText');
    const loginLoading = document.getElementById('loginLoading');
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    const loginTypeText = document.getElementById('loginTypeText');

    // ğŸ” æ£€æŸ¥ URL å‚æ•°,åˆ¤æ–­ç™»å½•åœºæ™¯
    const urlParams = new URLSearchParams(window.location.search);
    const redirectType = urlParams.get('redirect');  // 'client' è¡¨ç¤ºæ¥è‡ªå®¢æˆ·ç«¯
    const nodeId = urlParams.get('node_id') || 'node-5';  // é»˜è®¤æœ¬åœ°èŠ‚ç‚¹

    // æ ¹æ®åœºæ™¯æ˜¾ç¤ºä¸åŒçš„æç¤º
    if (redirectType === 'client') {
      loginTypeText.textContent = 'å®¢æˆ·ç«¯è®¿é—®è®¤è¯';
    } else {
      loginTypeText.textContent = 'ä¸»æ§ç®¡ç†ä¸­å¿ƒ';
    }

    function showError(message) {
      errorText.textContent = message;
      errorMessage.classList.add('show');
      setTimeout(() => {
        errorMessage.classList.remove('show');
      }, 3000);
    }

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const username = usernameInput.value.trim();
      const password = passwordInput.value;

      if (!username || !password) {
        showError('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
        return;
      }

      loginButton.disabled = true;
      loginButtonText.textContent = 'ç™»å½•ä¸­...';
      loginLoading.style.display = 'inline-block';

      try {
        // 1. å…ˆç™»å½•
        const loginResponse = await axios.post(`${apiBaseUrl}/api/login`, {
          username: username,
          password: password
        });

        if (!loginResponse.data.success) {
          showError(loginResponse.data.message || 'ç™»å½•å¤±è´¥');
          loginButton.disabled = false;
          loginButtonText.textContent = 'ç™»å½•';
          loginLoading.style.display = 'none';
          return;
        }

        // 2. ç™»å½•æˆåŠŸå,æ ¹æ®åœºæ™¯å†³å®šè·³è½¬ç›®æ ‡
        if (redirectType === 'client') {
          // âœ… åœºæ™¯2: æ¥è‡ªå®¢æˆ·ç«¯ â†’ ç”Ÿæˆä»¤ç‰Œåè·³è½¬å›å®¢æˆ·ç«¯
          loginButtonText.textContent = 'æ­£åœ¨è·³è½¬åˆ°å®¢æˆ·ç«¯...';

          const tokenResponse = await axios.post(`${apiBaseUrl}/api/generate-node-access-token`, {
            node_id: nodeId
          });

          if (tokenResponse.data.success) {
            const token = tokenResponse.data.token;

            // è·³è½¬åˆ°å®¢æˆ·ç«¯æ¡Œé¢,æºå¸¦è®¿é—®ä»¤ç‰Œ
            window.location.href = `http://127.0.0.1:5000/desktop?token=${token}`;
          } else {
            showError('ç”Ÿæˆè®¿é—®ä»¤ç‰Œå¤±è´¥');
            loginButton.disabled = false;
            loginButtonText.textContent = 'ç™»å½•';
            loginLoading.style.display = 'none';
          }
        } else {
          // âœ… åœºæ™¯1: é¦–æ¬¡ç™»å½•ç®¡ç†ç«¯ â†’ è·³è½¬åˆ°ç®¡ç†ç«¯é¦–é¡µ
          loginButtonText.textContent = 'æ­£åœ¨è·³è½¬åˆ°ç®¡ç†ä¸­å¿ƒ...';
          window.location.href = '/';
        }

      } catch (error) {
        console.error('ç™»å½•é”™è¯¯:', error);
        const message = error.response?.data?.message || 'ç™»å½•å¤±è´¥,è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
        showError(message);
        loginButton.disabled = false;
        loginButtonText.textContent = 'ç™»å½•';
        loginLoading.style.display = 'none';
      }
    });

    async function checkAuth() {
      try {
        const response = await axios.get(`${apiBaseUrl}/api/check-auth`);
        if (response.data.authenticated) {
          // å·²ç™»å½•
          if (redirectType === 'client') {
            // å¦‚æœæ˜¯ä»å®¢æˆ·ç«¯æ¥çš„,ç›´æ¥ç”Ÿæˆä»¤ç‰Œè·³è½¬
            const tokenResponse = await axios.post(`${apiBaseUrl}/api/generate-node-access-token`, {
              node_id: nodeId
            });
            if (tokenResponse.data.success) {
              window.location.href = `http://127.0.0.1:5000/desktop?token=${tokenResponse.data.token}`;
            }
          } else {
            // å¦åˆ™è·³è½¬åˆ°ç®¡ç†ç«¯é¦–é¡µ
            window.location.href = '/';
          }
        }
      } catch (error) {
        // æœªç™»å½•,åœç•™åœ¨ç™»å½•é¡µ
      }
    }

    checkAuth();
  </script>

</body>
</html>