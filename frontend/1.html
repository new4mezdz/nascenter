<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NAS Center 管理系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    /* 新增: 开始菜单样式 */
.start-menu {
  position: fixed;
  bottom: 60px;
  left: 20px;
  width: 400px;
  background: rgba(30, 30, 30, 0.98);
  backdrop-filter: blur(20px);
  border-radius: 12px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  color: white;
  overflow: hidden;
  z-index: 1500;
  animation: slideUp 0.2s ease-out;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.start-menu-header {
  padding: 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.start-menu-section {
  padding: 12px;
}

.start-menu-section-title {
  padding: 8px 12px;
  font-size: 11px;
  font-weight: 600;
  color: rgba(255,255,255,0.6);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.start-menu-item {
  padding: 12px 16px;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 12px;
  transition: all 0.15s;
}

.start-menu-item:hover {
  background: rgba(255,255,255,0.1);
}

.start-menu-item-disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* 新增: 顶部导航栏样式 */
.top-navbar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 45px;
  background: rgba(0,0,0,0.85);
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  padding: 0 20px;
  z-index: 999;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.navbar-button {
  padding: 6px 16px;
  background: rgba(255,255,255,0.1);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  color: white;
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 6px;
  border: 1px solid rgba(255,255,255,0.2);
}

.navbar-button:hover {
  background: rgba(255,255,255,0.2);
}

.navbar-divider {
  width: 1px;
  height: 24px;
  background: rgba(255,255,255,0.2);
  margin: 0 12px;
}

/* 调整桌面区域以适应顶部导航栏 */
.desktop-with-navbar {
  padding-top: 45px;
}
    .desktop {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      position: relative;
      user-select: none;
    }

    .desktop-icon {
      width: 90px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      padding: 8px;
    }

    .desktop-icon:hover {
      transform: translateY(-2px);
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
    }

    .window {
      position: absolute;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
      min-width: 400px;
      min-height: 300px;
      display: flex;
      flex-direction: column;
    }

    .window.maximized {
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: calc(100vh - 50px) !important;
      border-radius: 0;
    }

    .window-header {
      background: linear-gradient(180deg, #f7f7f7 0%, #e8e8e8 100%);
      padding: 12px 16px;
      cursor: move;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ddd;
    }

    .window-controls button {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: none;
      margin-left: 8px;
      cursor: pointer;
    }

    .window-controls .close { background: #ff5f57; }
    .window-controls .minimize { background: #ffbd2e; }
    .window-controls .maximize { background: #28ca42; }

    .window-content {
      flex: 1;
      overflow: auto;
    }

    .taskbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 50px;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      padding: 0 20px;
      z-index: 1000;
    }

    .taskbar-item {
      height: 40px;
      padding: 0 16px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      margin-right: 8px;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s;
      color: white;
    }

    .taskbar-item:hover {
      background: rgba(255,255,255,0.2);
    }

    .taskbar-item.active {
      background: rgba(255,255,255,0.3);
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .window {
      animation: fadeIn 0.2s ease-out;
    }

    .icon-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, 90px);
      gap: 20px;
      padding: 20px;
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }


    /* 手机端适配 */
@media (max-width: 768px) {
  .window {
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: auto !important;
    bottom: 50px !important;
    border-radius: 0;
    min-width: 100%;
  }

  .window.maximized {
    height: auto !important;
    bottom: 50px !important;
  }

  .start-menu {
    width: calc(100% - 40px);
    left: 20px;
    right: 20px;
  }

  .top-navbar {
    padding: 0 12px;
  }

  .navbar-button {
    font-size: 12px;
    padding: 6px 12px;
  }

  .desktop-icon {
    width: 70px;
  }

  .desktop-icon:hover {
    background: transparent !important;
    transform: translateY(-2px);
  }

  .taskbar {
    padding: 0 12px;
  }

  .taskbar-item {
    padding: 0 12px;
    font-size: 13px;
  }

  /* 统计卡片单列显示 */
  .grid.grid-cols-4 {
    grid-template-columns: 1fr !important;
    gap: 16px !important;
  }

/* 所有grid在手机端都改成单列 */
.grid {
  grid-template-columns: 1fr !important;
  gap: 16px !important;
}

/* 但网络带宽内部的2列grid保持不变 */
.grid.grid-cols-2.gap-4 {
  grid-template-columns: 1fr 1fr !important;
}

  /* 表格最小宽度，保证可以横向滚动 */
  table {
    min-width: 800px !important;
  }

  /* 窗口内容：只允许纵向滚动 */
  .window-content {
    overflow-y: auto !important;
    overflow-x: hidden !important;
    -webkit-overflow-scrolling: touch;
  }

 /* 禁用所有内部容器的纵向滚动 */
.flex-1.overflow-auto {
  overflow-y: visible !important;
  overflow-x: visible !important;
}

  /* 或者直接针对包含表格的div */
  .bg-white.rounded-lg.shadow.border {
    overflow-x: auto !important;
    overflow-y: visible !important;
    -webkit-overflow-scrolling: touch;
  }

  /* 手机端显示滚动条 */
  .window-content::-webkit-scrollbar {
    width: 6px;
  }

  .window-content::-webkit-scrollbar-track {
    background: #f1f1f1;
  }

  .window-content::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
  }

  /* 表格横向滚动条 */
  .bg-white.rounded-lg.shadow.border::-webkit-scrollbar {
    height: 6px;
  }

  .bg-white.rounded-lg.shadow.border::-webkit-scrollbar-track {
    background: #f1f1f1;
  }

  .bg-white.rounded-lg.shadow.border::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
  }

  .flex-1.overflow-auto.p-6 {
    padding-bottom: 100px !important;
  }
}


  </style>
</head>
<body>

  <div id="app">
    <div class="top-navbar" v-if="showNavbar">
    <div class="flex items-center gap-2">
      <button @click="returnToMainCenter" class="navbar-button">
        <span>🏠</span>
        <span>返回主控中心</span>
      </button>

      <div class="navbar-divider"></div>

      <span class="text-white text-sm flex items-center gap-2">
        <span class="text-green-400">●</span>
        当前节点: <strong>{{ currentNodeName }}</strong>
      </span>
    </div>

    <div class="ml-auto flex items-center gap-3">
      <button @click="openNodeManagement" class="navbar-button">
        <span>🔄</span>
        <span>切换节点</span>
      </button>

      <button @click="refreshCurrentNode" class="navbar-button">
        <span>🔃</span>
        <span>刷新</span>
      </button>
    </div>
  </div>
    <div :class="['desktop fixed inset-0', { 'desktop-with-navbar': showNavbar }]" @click="closeAllMenus">

      <div class="icon-grid p-8">
        <!-- 节点管理 -->
        <div class="desktop-icon" @dblclick="openNodeManagement">
          <div class="w-16 h-16 mx-auto mb-2 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-4xl">
            🖥️
          </div>
          <div class="text-white text-xs font-semibold drop-shadow-lg">节点管理</div>
        </div>

        <!-- 空间分配 -->
        <div class="desktop-icon" @dblclick="openSpaceAllocation">
          <div class="w-16 h-16 mx-auto mb-2 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-4xl">
            📦
          </div>
          <div class="text-white text-xs font-semibold drop-shadow-lg">空间分配</div>
        </div>

        <!-- 权限设置 -->
        <div class="desktop-icon" @dblclick="openPermissionSettings">
          <div class="w-16 h-16 mx-auto mb-2 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-4xl">
            🔒
          </div>
          <div class="text-white text-xs font-semibold drop-shadow-lg">权限设置</div>
        </div>

        <!-- 加密管理 -->
        <div class="desktop-icon" @dblclick="openEncryptionManager">
          <div class="w-16 h-16 mx-auto mb-2 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-4xl">
            🔐
          </div>
          <div class="text-white text-xs font-semibold drop-shadow-lg">加密管理</div>
        </div>

        <!-- 纠删码配置 -->
        <div class="desktop-icon" @dblclick="openECConfig">
          <div class="w-16 h-16 mx-auto mb-2 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-4xl">
            🛡️
          </div>
          <div class="text-white text-xs font-semibold drop-shadow-lg">纠删码配置</div>
        </div>

        <!-- 系统监控 -->
        <div class="desktop-icon" @dblclick="openSystemMonitor">
          <div class="w-16 h-16 mx-auto mb-2 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-4xl">
            📊
          </div>
          <div class="text-white text-xs font-semibold drop-shadow-lg">系统监控</div>
        </div>
      </div>

      <div v-for="window in windows" :key="window.id"
           :class="['window', { maximized: window.maximized }]"
           :style="window.maximized ? {} : {
             top: window.y + 'px',
             left: window.x + 'px',
             width: window.width + 'px',
             height: window.height + 'px',
             zIndex: window.zIndex,
             display: window.minimized ? 'none' : 'flex'
           }"
           @mousedown="focusWindow(window.id)">

        <div class="window-header" @mousedown="startDrag($event, window)">
          <div class="flex items-center gap-2">
            <span class="text-2xl">{{ window.icon }}</span>
            <span class="font-semibold text-sm">{{ window.title }}</span>
          </div>
          <div class="window-controls flex">
            <button class="minimize" @click.stop="minimizeWindow(window.id)"></button>
            <button class="maximize" @click.stop="toggleMaximize(window.id)"></button>
            <button class="close" @click.stop="closeWindow(window.id)"></button>
          </div>
        </div>

        <div class="window-content" style="padding: 0; overflow: hidden;">

          <!-- 节点管理窗口 -->
          <div v-if="window.type === 'nodes'" class="h-full flex flex-col">
            <div class="px-6 py-4 border-b bg-gradient-to-r from-blue-50 to-purple-50">
              <div class="flex justify-between items-center">
                <div>
                  <h3 class="text-xl font-bold flex items-center gap-2">
                    <span class="text-3xl">🖥️</span>
                    节点管理
                  </h3>
                  <p class="text-sm text-gray-600 mt-1">管理和监控所有 NAS 节点</p>
                </div>
                <button @click="refreshNodes(window)"
                        class="px-4 py-2 bg-white border rounded-lg hover:bg-gray-50 transition flex items-center gap-2">
                  <span v-if="window.loading" class="loading"></span>
                  <span v-else>🔄</span>
                  刷新
                </button>
              </div>
            </div>

            <div v-if="window.stats" class="grid grid-cols-4 gap-4 p-6 bg-gray-50">
              <div class="bg-white rounded-lg shadow p-4 border">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-xs text-gray-600 mb-1">总节点</div>
                    <div class="text-2xl font-bold text-blue-600">{{ window.stats.total }}</div>
                  </div>
                  <div class="text-4xl">🖥️</div>
                </div>
              </div>
              <div class="bg-white rounded-lg shadow p-4 border">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-xs text-gray-600 mb-1">在线</div>
                    <div class="text-2xl font-bold text-green-600">{{ window.stats.online }}</div>
                  </div>
                  <div class="text-4xl">✅</div>
                </div>
              </div>
              <div class="bg-white rounded-lg shadow p-4 border">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-xs text-gray-600 mb-1">离线</div>
                    <div class="text-2xl font-bold text-red-600">{{ window.stats.offline }}</div>
                  </div>
                  <div class="text-4xl">❌</div>
                </div>
              </div>
              <div class="bg-white rounded-lg shadow p-4 border">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-xs text-gray-600 mb-1">警告</div>
                    <div class="text-2xl font-bold text-yellow-600">{{ window.stats.warning }}</div>
                  </div>
                  <div class="text-4xl">⚠️</div>
                </div>
              </div>
            </div>

            <div class="p-6 bg-gray-50">
  <div class="bg-white rounded-lg shadow border overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gray-50 border-b">
                    <tr>
                      <th class="text-left p-4 font-semibold text-gray-700">节点名称</th>
                      <th class="text-left p-4 font-semibold text-gray-700">地址</th>
                      <th class="text-left p-4 font-semibold text-gray-700">状态</th>
                      <th class="text-left p-4 font-semibold text-gray-700">CPU</th>
                      <th class="text-left p-4 font-semibold text-gray-700">内存</th>
                      <th class="text-left p-4 font-semibold text-gray-700">磁盘</th>
                      <th class="text-left p-4 font-semibold text-gray-700">操作</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="node in window.nodes" :key="node.id"
                        class="border-b hover:bg-gray-50">
                      <td class="p-4">
                        <div class="font-semibold text-gray-800">{{ node.name }}</div>
                        <div class="text-xs text-gray-500">{{ node.id }}</div>
                      </td>
                      <td class="p-4 text-sm">{{ node.ip }}:{{ node.port }}</td>
                      <td class="p-4">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold"
                              :class="getStatusClass(node.status)">
                          {{ getStatusText(node.status) }}
                        </span>
                      </td>
                      <td class="p-4">
                        <span v-if="node.status !== 'offline'" class="text-sm font-semibold"
                              :class="node.cpu_usage > 80 ? 'text-red-600' : 'text-gray-700'">
                          {{ node.cpu_usage.toFixed(1) }}%
                        </span>
                        <span v-else class="text-sm text-gray-400">-</span>
                      </td>
                      <td class="p-4">
                        <span v-if="node.status !== 'offline'" class="text-sm font-semibold"
                              :class="node.memory_usage > 80 ? 'text-red-600' : 'text-gray-700'">
                          {{ node.memory_usage.toFixed(1) }}%
                        </span>
                        <span v-else class="text-sm text-gray-400">-</span>
                      </td>
                      <td class="p-4">
                        <span v-if="node.status !== 'offline'" class="text-sm font-semibold"
                              :class="node.disk_usage > 80 ? 'text-red-600' : 'text-gray-700'">
                          {{ node.disk_usage.toFixed(1) }}%
                        </span>
                        <span v-else class="text-sm text-gray-400">-</span>
                      </td>
                      <td class="p-4">
                        <div class="flex gap-2">
                           <button @click="renameNode(window, node)"
            class="px-3 py-1 bg-purple-500 hover:bg-purple-600 text-white rounded text-xs">
      ✏️ 改名
    </button>
                          <button @click="viewNodeDisks(window, node)"
                                  :disabled="node.status === 'offline'"
                                  :class="node.status === 'offline' ? 'opacity-50 cursor-not-allowed bg-gray-400' : 'bg-blue-500 hover:bg-blue-600'"
                                  class="px-3 py-1 text-white rounded text-xs">
                            💾 磁盘
                          </button>
                          <button @click="accessNode(node)"
                                  :disabled="node.status === 'offline'"
                                  :class="node.status === 'offline' ? 'opacity-50 cursor-not-allowed bg-gray-400' : 'bg-green-500 hover:bg-green-600'"
                                  class="px-3 py-1 text-white rounded text-xs">
                            🔗 访问
                          </button>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- 磁盘信息弹窗 -->
            <div v-if="window.selectedNodeDisks"
                 @click="window.selectedNodeDisks = null"
                 class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div @click.stop class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-[80vh] overflow-hidden">
                <div class="px-6 py-4 border-b bg-gradient-to-r from-blue-500 to-purple-600 text-white">
                  <h3 class="text-xl font-bold">{{ window.selectedNodeDisks.name }} - 磁盘信息</h3>
                </div>
                <div class="p-6 overflow-y-auto max-h-[60vh]">
                  <div v-if="window.selectedNodeDisks.loading" class="flex items-center justify-center py-12">
                    <div class="loading"></div>
                    <span class="ml-3 text-gray-600">正在加载磁盘信息...</span>
                  </div>
                  <div v-else-if="window.selectedNodeDisks.error" class="text-center py-12">
                    <div class="text-red-500 text-lg mb-2">❌ 加载失败</div>
                    <div class="text-gray-600">{{ window.selectedNodeDisks.error }}</div>
                  </div>
                  <div v-else class="space-y-4">
                    <div v-for="(disk, index) in window.selectedNodeDisks.disks" :key="index"
                         class="border rounded-lg p-4 bg-gray-50">
                      <div class="flex justify-between items-start mb-3">
                        <div>
                          <div class="font-bold text-lg">{{ disk.mount }}</div>
                          <div class="text-sm text-gray-600">总容量: {{ disk.total_gb }} GB</div>
                        </div>
                        <span v-if="disk.ec_scheme" class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">
                          🛡️ {{ disk.ec_scheme }}
                        </span>
                      </div>
                      <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="h-4 rounded-full flex items-center justify-center text-xs text-white font-semibold"
                             :class="disk.usage_percent > 90 ? 'bg-red-500' : disk.usage_percent > 70 ? 'bg-yellow-500' : 'bg-green-500'"
                             :style="{ width: disk.usage_percent + '%' }">
                          {{ disk.usage_percent.toFixed(1) }}%
                        </div>
                      </div>
                      <div class="flex justify-between text-xs text-gray-600 mt-2">
                        <span>已用: {{ disk.used_gb }} GB</span>
                        <span>可用: {{ disk.free_gb }} GB</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="px-6 py-4 border-t bg-gray-50 flex justify-end">
                  <button @click="window.selectedNodeDisks = null"
                          class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                    关闭
                  </button>
                </div>
              </div>
            </div>
          </div>


          <div v-if="window.type === 'user-management'" class="h-full flex flex-col">
            <div class="px-6 py-4 border-b bg-gradient-to-r from-gray-50 to-gray-100">
              <div class="flex justify-between items-center">
                <div>
                  <h3 class="text-xl font-bold flex items-center gap-2">
                    <span class="text-3xl">👥</span>
                    用户管理
                  </h3>
                  <p class="text-sm text-gray-600 mt-1">创建、编辑和管理所有系统用户</p>
                </div>
                <button @click="createUser(window)"
                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition flex items-center gap-2">
                  <span>+</span>
                  添加新用户
                </button>
              </div>
            </div>

            <div v-if="window.loading" class="flex-1 flex items-center justify-center">
              <div class="loading"></div>
              <span class="ml-3 text-gray-600">正在加载用户列表...</span>
            </div>

            <div v-else class="flex-1 overflow-auto p-6 bg-gray-50">
              <div class="bg-white rounded-lg shadow border">
                <table class="w-full">
                  <thead class="bg-gray-50 border-b">
                    <tr>
                      <th class="text-left p-4 font-semibold text-gray-700">用户名</th>
                      <th class="text-left p-4 font-semibold text-gray-700">邮箱</th>
                      <th class="text-left p-4 font-semibold text-gray-700">角色</th>
                      <th class="text-left p-4 font-semibold text-gray-700">状态</th>
                      <th class="text-left p-4 font-semibold text-gray-700">操作</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="user in window.users" :key="user.id"
                        class="border-b hover:bg-gray-50">

                      <td class="p-4">
                        <div class="font-semibold text-gray-800">{{ user.username }}</div>
                        <div class="text-xs text-gray-500">ID: {{ user.id }}</div>
                      </td>

                      <td class="p-4 text-sm">{{ user.email || 'N/A' }}</td>

                      <td class="p-4">
                        <span v-if="user.role === 'admin'" class="px-3 py-1 rounded-full text-xs font-semibold bg-purple-100 text-purple-700">
                          👑 管理员
                        </span>
                        <span v-else class="px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-700">
                          👤 普通用户
                        </span>
                      </td>

                      <td class="p-4">
                        <span v-if="user.status === 'active'" class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">
                          ✓ 活跃
                        </span>
                        <span v-else class="px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700">
                          ✗ 已禁用
                        </span>
                      </td>

                      <td class="p-4">
                        <div class="flex gap-2">
                          <button @click="updateUser(window, user)"
                                  :disabled="user.username === 'admin'"
                                  :class="user.username === 'admin' ? 'opacity-50 cursor-not-allowed bg-gray-400' : 'bg-green-500 hover:bg-green-600'"
                                  class="px-3 py-1 text-white rounded text-xs">
                            ✏️ 编辑
                          </button>
                          <button @click="deleteUser(window, user)"
                                  :disabled="user.username === 'admin'"
                                  :class="user.username === 'admin' ? 'opacity-50 cursor-not-allowed bg-gray-400' : 'bg-red-500 hover:bg-red-600'"
                                  class="px-3 py-1 text-white rounded text-xs">
                            🗑️ 删除
                          </button>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- 空间分配窗口 -->
          <div v-if="window.type === 'space-allocation'" class="h-full flex flex-col">
            <div class="px-6 py-4 border-b bg-gradient-to-r from-purple-50 to-pink-50">
              <h3 class="text-xl font-bold flex items-center gap-2">
                <span class="text-3xl">📦</span>
                跨节点空间分配
              </h3>
              <p class="text-sm text-gray-600 mt-1">将大文件分发到多个节点存储,优化空间利用</p>
            </div>

            <div class="flex-1 overflow-auto p-6 bg-gray-50">
              <!-- 分配策略选择 -->
              <div class="bg-white rounded-lg shadow border p-6 mb-6">
                <h4 class="font-bold text-lg mb-4">分配策略</h4>
                <div class="grid grid-cols-3 gap-4">
                  <div class="border-2 border-blue-500 rounded-lg p-4 cursor-pointer hover:bg-blue-50">
                    <div class="text-3xl mb-2">⚖️</div>
                    <div class="font-semibold">负载均衡</div>
                    <div class="text-xs text-gray-600 mt-1">平均分配到所有节点</div>
                  </div>
                  <div class="border-2 border-gray-300 rounded-lg p-4 cursor-pointer hover:bg-gray-50">
                    <div class="text-3xl mb-2">💾</div>
                    <div class="font-semibold">空间优先</div>
                    <div class="text-xs text-gray-600 mt-1">优先使用空间较大的节点</div>
                  </div>
                  <div class="border-2 border-gray-300 rounded-lg p-4 cursor-pointer hover:bg-gray-50">
                    <div class="text-3xl mb-2">⚡</div>
                    <div class="font-semibold">性能优先</div>
                    <div class="text-xs text-gray-600 mt-1">优先使用高性能节点</div>
                  </div>
                </div>
              </div>

              <!-- 源文件选择 -->
              <div class="bg-white rounded-lg shadow border p-6 mb-6">
                <h4 class="font-bold text-lg mb-4">选择要分配的文件</h4>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                  <div class="text-6xl mb-4">📁</div>
                  <p class="text-gray-600 mb-4">选择源节点和文件</p>
                  <button class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                    浏览文件
                  </button>
                </div>

                <!-- 已选文件列表示例 -->
                <div class="mt-4 space-y-2">
                  <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-3">
                      <span class="text-2xl">🎬</span>
                      <div>
                        <div class="font-semibold">movie_4K.mp4</div>
                        <div class="text-xs text-gray-500">25.6 GB - 来自节点: NAS-主节点</div>
                      </div>
                    </div>
                    <button class="text-red-500 hover:text-red-700">✕</button>
                  </div>
                </div>
              </div>

              <!-- 目标节点选择 -->
              <div class="bg-white rounded-lg shadow border p-6 mb-6">
                <h4 class="font-bold text-lg mb-4">选择目标节点 (至少2个)</h4>
                <div class="space-y-2">
                  <div class="flex items-center p-3 border-2 border-blue-500 bg-blue-50 rounded-lg">
                    <input type="checkbox" checked class="mr-3 h-5 w-5">
                    <div class="flex-1">
                      <div class="font-semibold">NAS-备份节点</div>
                      <div class="text-xs text-gray-600">可用空间: 1.2 TB | CPU: 25% | 延迟: 12ms</div>
                    </div>
                    <div class="text-green-600 font-semibold">✓ 已选</div>
                  </div>

                  <div class="flex items-center p-3 border-2 border-blue-500 bg-blue-50 rounded-lg">
                    <input type="checkbox" checked class="mr-3 h-5 w-5">
                    <div class="flex-1">
                      <div class="font-semibold">我的本地节点</div>
                      <div class="text-xs text-gray-600">可用空间: 800 GB | CPU: 15% | 延迟: 2ms</div>
                    </div>
                    <div class="text-green-600 font-semibold">✓ 已选</div>
                  </div>

                  <div class="flex items-center p-3 border-2 border-gray-300 rounded-lg">
                    <input type="checkbox" class="mr-3 h-5 w-5">
                    <div class="flex-1">
                      <div class="font-semibold">NAS-存档节点</div>
                      <div class="text-xs text-gray-600">可用空间: 3.5 TB | CPU: 40% | 延迟: 28ms</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 分配预览 -->
              <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-l-4 border-blue-500 p-4 rounded">
                <h4 class="font-semibold text-blue-900 mb-2">📊 分配预览</h4>
                <div class="text-sm text-blue-800 space-y-1">
                  <p>• 文件数量: <strong>1</strong> 个</p>
                  <p>• 总大小: <strong>25.6 GB</strong></p>
                  <p>• 目标节点: <strong>2</strong> 个</p>
                  <p>• 每节点分配: <strong>约 12.8 GB</strong></p>
                  <p>• 预计耗时: <strong>约 8-12 分钟</strong></p>
                </div>
              </div>

              <!-- 执行按钮 -->
              <div class="mt-6 flex justify-end gap-3">
                <button class="px-6 py-3 bg-gray-200 rounded-lg hover:bg-gray-300">
                  取消
                </button>
                <button class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2">
                  <span>🚀</span>
                  开始分配
                </button>
              </div>
            </div>
          </div>

          <!-- 权限设置窗口 -->
          <div v-if="window.type === 'permissions'" class="h-full flex flex-col">
            <div v-if="window.loading" class="absolute inset-0 bg-white/50 flex items-center justify-center z-10" style="top: 0; left: 0; right: 0; bottom: 0;">
              <div class="loading"></div> <span class="ml-2">正在加载数据...</span>
            </div>
            <div class="px-6 py-4 border-b bg-gradient-to-r from-orange-50 to-red-50">
              <h3 class="text-xl font-bold flex items-center gap-2">
                <span class="text-3xl">🔒</span>
                权限管理
              </h3>
              <p class="text-sm text-gray-600 mt-1">配置用户和节点的访问权限</p>
            </div>

            <div class="flex-1 overflow-auto p-6 bg-gray-50">

               <!-- 标签页切换 -->
  <div class="flex gap-2 mb-6 border-b">
    <button @click="window.permissionTab = 'users'"
            :class="window.permissionTab === 'users' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
            class="px-4 py-2 font-semibold">
      👥 用户权限
    </button>
    <button @click="window.permissionTab = 'groups'"
            :class="window.permissionTab === 'groups' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
            class="px-4 py-2 font-semibold">
      📁 节点分组
    </button>
    <button @click="window.permissionTab = 'nodes'"
            :class="window.permissionTab === 'nodes' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
            class="px-4 py-2 font-semibold">
      🖥️ 节点控制
    </button>
  </div>

<div v-if="window.permissionTab === 'users'">
              <!-- 用户权限管理 -->
              <div class="bg-white rounded-lg shadow border p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                  <h4 class="font-bold text-lg">用户访问权限</h4>
                  <button @click="createUser(window)"
        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
  + 添加用户
</button>
                </div>

                <table class="w-full">
                  <thead class="bg-gray-50 border-b">
                    <tr>
                      <th class="text-left p-3 font-semibold text-gray-700">用户名</th>
                      <th class="text-left p-3 font-semibold text-gray-700">角色</th>
                      <th class="text-left p-3 font-semibold text-gray-700">文件权限</th>
                      <th class="text-left p-3 font-semibold text-gray-700">节点权限</th>
                      <th class="text-left p-3 font-semibold text-gray-700">操作</th>
                    </tr>
                  </thead>
                  <tbody v-if="!window.loading">
  <tr v-if="!window.users || window.users.length === 0">
    <td colspan="5" class="p-8 text-center text-gray-500">
      <div class="text-4xl mb-2">👥</div>
      <div class="text-sm">暂无用户</div>
    </td>
  </tr>
  <tr v-for="user in window.users || []" :key="user.id" class="border-b hover:bg-gray-50">

    <td class="p-3">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-xs">
          {{ user.username[0].toUpperCase() }}
        </div>
        <span class="font-semibold">{{ user.username }}</span>
      </div>
    </td>

    <td class="p-3">
      <select v-model="user.role" @change="updateUserPermissions(user)"
              :disabled="user.username === 'admin'"
              class="px-3 py-1 border rounded text-xs"
              :class="{ 'cursor-not-allowed bg-gray-100': user.username === 'admin' }">
        <option value="admin">👑 管理员</option>
        <option value="user">👤 普通用户</option>
        <option value="guest">👁️ 访客</option>
      </select>
    </td>

    <td class="p-3">
      <select v-model="user.file_permission" @change="updateUserPermissions(user)"
              :disabled="user.username === 'admin'"
              class="px-3 py-1 border rounded text-xs"
              :class="{ 'cursor-not-allowed bg-gray-100': user.username === 'admin' }">
        <option value="readonly">👁️ 只读</option>
        <option value="readwrite">✏️ 读写</option>
        <option value="fullcontrol">🔓 完全控制</option>
      </select>
    </td>

    <td class="p-3">
      <select v-model="user.node_access.type" @change="updateUserNodeAccess(user)"
              :disabled="user.username === 'admin'"
              class="px-3 py-1 border rounded text-xs"
              :class="{ 'cursor-not-allowed bg-gray-100': user.username === 'admin' }">
        <option value="all">✓ 所有节点</option>
        <option value="groups">按分组</option>
        <option value="custom">自定义</option>
      </select>
    </td>

    <td class="p-3">
      <div v-if="user.username === 'admin'" class="flex gap-2">
        <button class="px-3 py-1 bg-gray-300 text-gray-500 rounded text-xs cursor-not-allowed">
          系统管理员
        </button>
      </div>
      <div v-else class="flex gap-2">
        <button @click="openUserAccessDetail(user)" class="px-3 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">
          编辑
        </button>
        <button @click="deleteUser(window, user)" class="px-3 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">
          删除
        </button>
      </div>
    </td>
  </tr>
</tbody>
                </table>
              </div>

              <!-- 权限类型说明 -->
              <div class="bg-white rounded-lg shadow border p-6 mb-6">
                <h4 class="font-bold text-lg mb-4">权限说明</h4>
                <div class="grid grid-cols-3 gap-4">
                  <div class="border rounded-lg p-4">
                    <div class="text-3xl mb-2">👁️</div>
                    <div class="font-semibold mb-1">只读权限</div>
                    <div class="text-xs text-gray-600">
                     • 查看文件列表<br>
                      • 下载文件<br>
                      • 🚫 不能上传/修改/删除文件<br>
                      • 🚫 不能进行系统配置
                    </div>
                  </div>

                  <div class="border rounded-lg p-4">
                    <div class="text-3xl mb-2">✏️</div>
                    <div class="font-semibold mb-1">读写权限</div>
                    <div class="text-xs text-gray-600">
                      • 所有只读权限<br>
                      • 上传文件<br>
                      • 创建文件夹<br>
                      • 重命名文件<br>
                      • 删除自己的文件
                    </div>
                  </div>

                  <div class="border rounded-lg p-4">
                    <div class="text-3xl mb-2">🔓</div>
                    <div class="font-semibold mb-1">完全控制</div>
                    <div class="text-xs text-gray-600">
                      • 所有读写权限<br>
                      • 删除任何文件<br>
                      • 修改权限<br>
                      • 系统配置<br>
                      • 用户管理
                    </div>
                  </div>
                  <!-- 加密功能说明 -->
<div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200 p-6 mt-4">
  <div class="flex items-start gap-3">
    <div class="text-3xl">🔐</div>
    <div class="flex-1">
      <div class="font-semibold text-lg mb-2">文件加密</div>
      <div class="text-sm text-gray-700">
        • <span class="font-medium">权限要求:</span> 读写权限及以上用户<br>
        • <span class="font-medium">主要作用:</span> 对敏感文件进行端到端加密存储,确保数据安全<br>
        • <span class="font-medium">功能:</span> 加密上传、解密下载、密钥管理
      </div>
    </div>
  </div>
</div>
                </div>
              </div>
              </div>

              <!-- 节点分组标签页 -->
  <div v-if="window.permissionTab === 'groups'">
    <div class="bg-white rounded-lg shadow border p-6">
      <div class="flex justify-between items-center mb-4">
        <h4 class="font-bold text-lg">节点分组管理</h4>
        <button @click="openCreateGroupDialog(window)"
                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
          + 创建分组
        </button>
      </div>

      <!-- 分组列表 -->
      <div class="space-y-3">
        <div v-if="window.groups && window.groups.length === 0" class="text-center py-8 text-gray-500">
          <div class="text-4xl mb-2">📦</div>
          <div class="text-sm">还没有创建任何分组</div>
          <div class="text-xs mt-1">点击上方"创建分组"按钮开始</div>
        </div>
        <div v-for="group in window.groups || []" :key="group.id"
             class="border rounded-lg p-4 hover:bg-gray-50">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="text-3xl">{{ group.icon }}</span>
              <div>
                <div class="font-semibold">{{ group.name }}</div>
                <div class="text-xs text-gray-600">{{ group.description }}</div>
                <div class="text-xs text-gray-500 mt-1">
                  包含 {{ (group.nodes || []).length }} 个节点
                </div>
              </div>
            </div>
            <div class="flex gap-2">
              <button @click="openEditGroupDialog(window, group)"
                      class="px-3 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">
                编辑
              </button>
              <button @click="deleteNodeGroup(window, group)"
                      class="px-3 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">
                删除
              </button>
            </div>
          </div>

          <!-- 节点列表 -->
          <div v-if="group.nodes && group.nodes.length > 0" class="mt-3 pt-3 border-t">
            <div class="flex flex-wrap gap-2">
              <span v-for="nodeId in group.nodes" :key="nodeId"
                    class="px-2 py-1 bg-gray-100 rounded text-xs">
                🖥️ {{ getNodeName(nodeId) }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

              <!-- 节点访问控制标签页 -->
  <div v-if="window.permissionTab === 'nodes'">
              <div class="bg-white rounded-lg shadow border p-6">
  <h4 class="font-bold text-lg mb-4">节点访问控制</h4>
  <div class="space-y-3">

    <div v-if="window.nodes && window.nodes.length === 0" class="text-center py-8 text-gray-500">
      <div class="text-4xl mb-2">🖥️</div>
      <div class="text-sm">暂无节点</div>
    </div>

    <div v-for="node in window.nodes || []" :key="node.id"
         class="flex items-center justify-between p-4 border rounded-lg">
      <div class="flex items-center gap-3">
        <div class="text-3xl">🖥️</div>
        <div>
          <div class="font-semibold">{{ node.name }}</div>
          <div class="text-xs text-gray-600">{{ node.ip }}:{{ node.port }}</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-xs text-gray-600">访问策略:</span>
        <select v-model="window.nodePolicies[node.id]"
                @change="updateNodePolicy(node.id, $event.target.value)"
                class="px-3 py-1 border rounded text-sm">
          <option value="all_users">所有用户</option>
          <option value="admin_only">仅管理员</option>
          <option value="whitelist">白名单用户</option>
          <option value="disabled">禁止访问</option>
        </select>
      </div>
    </div>




                </div>
              </div>
  </div>
</div>

              <!-- 提示信息 -->
              <div class="mt-6 bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
                <div class="flex items-start gap-3">
                  <span class="text-2xl">⚠️</span>
                  <div class="text-sm text-yellow-800">
                    <p class="font-semibold mb-1">权限管理注意事项:</p>
                    <ul class="list-disc list-inside space-y-1">
                      <li>修改权限后立即生效,请谨慎操作</li>
                      <li>建议定期审查用户权限,确保安全</li>
                      <li>至少保留一个管理员账号</li>
                      <li>访客账号建议仅授予只读权限</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>


        <!-- 🔐 加密管理窗口 -->
<div v-if="window.type === 'encryption'" class="h-full flex flex-col">

  <!-- 顶部标题 -->
  <div class="px-6 py-4 border-b bg-gradient-to-r from-indigo-50 to-purple-50 flex justify-between items-center">
    <div>
      <h3 class="text-xl font-bold flex items-center gap-2">
        <span class="text-3xl">🔐</span>
        加密管理中心
      </h3>
      <p class="text-sm text-gray-600 mt-1">管理节点加密与磁盘加密状态</p>
    </div>
    <div v-if="window.encryptionView === 'detail'">
      <button @click="returnToEncryptionOverview(window)"
              class="px-4 py-2 bg-white border rounded-lg hover:bg-gray-50 transition">
        ← 返回节点列表
      </button>
    </div>
  </div>

  <!-- 加密页面内容 -->
  <div v-if="window.encryptionView === 'overview'" class="flex-1 p-6 bg-gray-50 overflow-auto">
    <div v-if="window.loading" class="text-center text-gray-500 py-8">加载节点中...</div>
    <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div v-for="node in window.nodes" :key="node.id"
           @click="openEncryptionDetail(window, node)"
           class="bg-white rounded-lg shadow border p-6 hover:shadow-lg hover:border-blue-500 cursor-pointer transition">
        <div class="flex justify-between items-center mb-2">
          <h4 class="font-bold text-lg text-gray-800">{{ node.name }}</h4>
          <span class="text-2xl">🖥️</span>
        </div>
        <p class="text-xs text-gray-500 mb-3">{{ node.ip }}:{{ node.port }}</p>
        <div class="text-sm text-gray-700">
          <span class="text-green-600">在线</span> | 模拟加密状态:
          <span class="font-semibold">未加密</span>
        </div>
      </div>
    </div>
  </div>

  <!-- 第二级磁盘加密页 -->
<div v-else-if="window.encryptionView === 'detail'" class="flex flex-1 overflow-hidden">
  <div class="flex-1 bg-gray-50 p-6 overflow-y-auto">
    <h4 class="text-lg font-semibold text-gray-700 mb-4">
      {{ window.selectedNodeName }} 的磁盘加密管理
    </h4>

    <div v-if="window.loading" class="text-center py-8 text-gray-500">加载磁盘中...</div>

    <div v-else>
      <table class="w-full text-sm border border-gray-200 bg-white rounded-lg overflow-hidden">
        <thead class="bg-gray-100 text-gray-700">
          <tr>
            <th class="border px-2 py-2 text-left">挂载点</th>
            <th class="border px-2 py-2 text-left">容量(GB)</th>
            <th class="border px-2 py-2 text-left">状态</th>
            <th class="border px-2 py-2 text-center">操作</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="disk in window.encryptionDisks" :key="disk.mount" class="hover:bg-gray-50">
            <td class="border px-2 py-2 font-mono">{{ disk.mount }}</td>
            <td class="border px-2 py-2">{{ disk.capacity_gb }}</td>
            <td class="border px-2 py-2">
              <span v-if="disk.is_encrypted && disk.is_locked" class="text-yellow-600 font-semibold">🔒 已锁定</span>
              <span v-else-if="disk.is_encrypted && !disk.is_locked" class="text-green-600 font-semibold">✅ 已加密</span>
              <span v-else class="text-gray-500">未加密</span>
            </td>
            <td class="border px-2 py-2 text-center">
              <!-- 未加密：启用加密 -->
              <button v-if="!disk.is_encrypted"
                      @click="encryptDisk(window, window.selectedNodeId, disk.mount)"
                      class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600">
                🔐 启用加密
              </button>

              <!-- 已加密 + 已锁定：解锁 -->
              <button v-else-if="disk.is_locked"
                      @click="unlockDisk(window, window.selectedNodeId, disk.mount)"
                      class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                🔓 解锁
              </button>

              <!-- 已加密 + 已解锁：显示3个操作 -->
              <div v-else class="flex justify-center gap-2">
                <button @click="lockDisk(window, window.selectedNodeId, disk.mount)"
                        class="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">
                  🔒 锁定
                </button>
                <button @click="decryptDisk(window, window.selectedNodeId, disk.mount)"
                        class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">
                  🧹 永久解密
                </button>
                <button @click="changePassword(window, window.selectedNodeId, disk.mount)"
                        class="px-3 py-1 bg-purple-500 text-white rounded hover:bg-purple-600">
                  🔑 改密码
                </button>
              </div>
            </td>
          </tr>
          <tr v-if="!window.encryptionDisks.length">
            <td colspan="4" class="text-center text-gray-500 py-4">暂无磁盘数据</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

</div>

<!-- 纠删码配置窗口 -->
<div v-else-if="window.type === 'ec-config'" class="h-full flex flex-col bg-gray-50">
  <!-- 标签页导航 -->
  <div class="flex border-b bg-white">
    <button @click="window.currentTab = 'config'"
            :class="window.currentTab === 'config' ? 'border-b-2 border-blue-500 text-blue-600 font-semibold' : 'text-gray-600'"
            class="px-6 py-3 transition">
      ⚙️ 配置
    </button>
    <button @click="window.currentTab = 'status'"
            :class="window.currentTab === 'status' ? 'border-b-2 border-blue-500 text-blue-600 font-semibold' : 'text-gray-600'"
            class="px-6 py-3 transition">
      📊 状态
    </button>
    <button @click="window.currentTab = 'recovery'"
            :class="window.currentTab === 'recovery' ? 'border-b-2 border-blue-500 text-blue-600 font-semibold' : 'text-gray-600'"
            class="px-6 py-3 transition">
      🔧 恢复
    </button>
  </div>

  <!-- 配置标签页 -->
  <div v-if="window.currentTab === 'config'" class="flex-1 overflow-auto p-6">
    <div v-if="window.loading" class="flex items-center justify-center h-64">
      <div class="loading"></div>
    </div>

    <div v-else>

       <div class="bg-white rounded-lg shadow p-4 border mb-6">
        <label class="block text-sm font-semibold mb-2">选择要配置的节点 *</label>
        <select v-model="window.selectedNodeId"
                @change="loadECConfig(window)"
                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">-- 请选择节点 --</option>
          <option v-for="node in window.nodes" :key="node.id" :value="node.id">
            {{ node.name }} ({{ node.ip }}:{{ node.port }})
          </option>
        </select>
      </div>
      <!-- 👆👆👆 节点选择框结束 👆👆👆 -->
      <!-- 当前配置状态卡片 -->
      <div v-if="window.ecConfig" class="bg-white rounded-lg shadow p-6 border mb-6">
        <div class="flex justify-between items-start mb-4">
          <div>
            <h3 class="text-xl font-bold mb-2 flex items-center gap-2">
              <span>✅</span> 纠删码已启用
            </h3>
            <div class="text-sm text-gray-600">当前使用 RS 纠删码算法保护节点内磁盘数据</div>
          </div>
          <button @click="deleteECConfig(window)"
                  class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm">
            删除配置
          </button>
        </div>

        <div class="grid grid-cols-4 gap-4 pt-4 border-t">
          <div class="bg-blue-50 p-4 rounded-lg">
            <div class="text-sm text-gray-600 mb-1">数据块 (K)</div>
            <div class="text-3xl font-bold text-blue-600">{{ window.ecConfig.k }}</div>
          </div>
          <div class="bg-purple-50 p-4 rounded-lg">
            <div class="text-sm text-gray-600 mb-1">校验块 (M)</div>
            <div class="text-3xl font-bold text-purple-600">{{ window.ecConfig.m }}</div>
          </div>
          <div class="bg-green-50 p-4 rounded-lg">
            <div class="text-sm text-gray-600 mb-1">容错能力</div>
            <div class="text-3xl font-bold text-green-600">{{ window.ecConfig.m }}</div>
          </div>
          <div class="bg-orange-50 p-4 rounded-lg">
            <div class="text-sm text-gray-600 mb-1">存储开销</div>
            <div class="text-3xl font-bold text-orange-600">
              {{ ((window.ecConfig.k + window.ecConfig.m) / window.ecConfig.k * 100 - 100).toFixed(0) }}%
            </div>
          </div>
        </div>

        <!-- 使用的磁盘列表 -->
        <div class="mt-6">
          <div class="text-sm font-semibold mb-3">已配置磁盘 ({{ window.ecConfig.disks?.length || 0 }}个)</div>
          <div class="grid grid-cols-3 gap-3">
            <div v-for="(disk, index) in window.ecConfig.disks" :key="index"
                 class="bg-gray-50 p-3 rounded-lg border flex items-center gap-2">
              <span class="text-2xl">💾</span>
              <span class="font-mono text-sm">{{ disk }}</span>
            </div>
          </div>
        </div>

        <!-- 容量信息 -->
        <div v-if="window.capacity" class="mt-6 pt-6 border-t">
          <div class="text-sm font-semibold mb-3">容量统计</div>
          <div class="grid grid-cols-3 gap-4">
            <div>
              <div class="text-xs text-gray-600 mb-1">可用总容量</div>
              <div class="text-xl font-bold text-blue-600">
                {{ formatBytes(window.capacity.usable_total_bytes) }}
              </div>
            </div>
            <div>
              <div class="text-xs text-gray-600 mb-1">可用剩余容量</div>
              <div class="text-xl font-bold text-green-600">
                {{ formatBytes(window.capacity.usable_free_bytes) }}
              </div>
            </div>
            <div>
              <div class="text-xs text-gray-600 mb-1">磁盘不平衡比例</div>
              <div class="text-xl font-bold"
                   :class="window.capacity.imbalance_ratio > 1.2 ? 'text-red-600' : 'text-green-600'">
                {{ window.capacity.imbalance_ratio.toFixed(2) }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 创建新配置表单 -->
      <div v-else class="max-w-3xl mx-auto">
        <div class="bg-white rounded-lg shadow p-8 border">
          <div class="text-center mb-8">
            <div class="text-6xl mb-4">🛡️</div>
            <h3 class="text-2xl font-bold mb-2">配置纠删码保护</h3>
            <p class="text-gray-600">为节点内的多个磁盘配置纠删码,提高数据可靠性</p>
          </div>

          <div class="space-y-6">
            <!-- K值(数据块) -->
            <div>
              <label class="block text-sm font-semibold mb-2">
                数据块数量 (K) *
                <span class="text-xs text-gray-500 font-normal ml-2">原始数据分成几块</span>
              </label>
              <input v-model.number="window.configForm.k"
                     type="number"
                     min="2"
                     max="16"
                     class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <!-- M值(校验块) -->
            <div>
              <label class="block text-sm font-semibold mb-2">
                校验块数量 (M) *
                <span class="text-xs text-gray-500 font-normal ml-2">最多容忍几个磁盘损坏</span>
              </label>
              <input v-model.number="window.configForm.m"
                     type="number"
                     min="1"
                     max="8"
                     class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <!-- 磁盘选择 -->
            <div>
              <label class="block text-sm font-semibold mb-2">
                选择磁盘 *
                <span class="text-xs text-gray-500 font-normal ml-2">
                  至少需要 {{ window.configForm.k + window.configForm.m }} 个磁盘
                </span>
              </label>
              <div class="border rounded-lg p-4 max-h-64 overflow-auto">
                <div v-if="window.availableDisks.length === 0" class="text-center py-8 text-gray-500">
                  <div class="text-4xl mb-2">💾</div>
                  <div class="text-sm">暂无可用磁盘</div>
                </div>
                <label v-for="disk in window.availableDisks" :key="disk.mount"
                       class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded cursor-pointer mb-2">
                  <input type="checkbox"
                         :value="disk.mount"
                         v-model="window.configForm.disks"
                         class="w-4 h-4">
                  <div class="flex-1">
                    <div class="flex items-center gap-2">
                      <span class="text-xl">💾</span>
                      <span class="font-mono font-semibold">{{ disk.mount }}</span>
                    </div>
                    <div class="text-xs text-gray-600 mt-1">
                      总容量: {{ formatBytes(disk.total) }} |
                      可用: {{ formatBytes(disk.free) }} ({{ ((disk.free / disk.total) * 100).toFixed(1) }}%)
                    </div>
                  </div>
                </label>
              </div>
              <div class="text-xs text-gray-600 mt-2">
                已选择 {{ window.configForm.disks.length }} 个磁盘
              </div>
            </div>

            <!-- 效果预览 -->
            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
              <div class="font-semibold text-blue-900 mb-3 flex items-center gap-2">
                <span>💡</span> 配置效果预览
              </div>
              <div class="space-y-2 text-sm text-blue-800">
                <div class="flex justify-between">
                  <span>总块数:</span>
                  <span class="font-bold">{{ window.configForm.k + window.configForm.m }} 块</span>
                </div>
                <div class="flex justify-between">
                  <span>容错能力:</span>
                  <span class="font-bold">最多 {{ window.configForm.m }} 个磁盘损坏</span>
                </div>
                <div class="flex justify-between">
                  <span>存储开销:</span>
                  <span class="font-bold">
                    {{ ((window.configForm.k + window.configForm.m) / window.configForm.k * 100 - 100).toFixed(1) }}%
                  </span>
                </div>
                <div class="flex justify-between">
                  <span>示例:</span>
                  <span class="font-bold">
                    1GB 数据需要 {{ ((window.configForm.k + window.configForm.m) / window.configForm.k).toFixed(2) }}GB 空间
                  </span>
                </div>
              </div>
            </div>

            <!-- 按钮 -->
            <div class="flex gap-3 pt-4">
              <button @click="saveECConfig(window)"
                      :disabled="window.configForm.disks.length < window.configForm.k + window.configForm.m"
                      :class="window.configForm.disks.length < window.configForm.k + window.configForm.m ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600'"
                      class="flex-1 px-6 py-3 text-white rounded-lg font-semibold">
                保存配置
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 状态标签页 -->
  <div v-else-if="window.currentTab === 'status'" class="flex-1 overflow-auto p-6">
    <div v-if="!window.ecConfig" class="flex items-center justify-center h-full">
      <div class="text-center">
        <div class="text-6xl mb-4">⚠️</div>
        <div class="text-xl font-semibold text-gray-700 mb-2">未配置纠删码</div>
        <div class="text-gray-600 mb-6">请先在"配置"标签页配置纠删码</div>
        <button @click="window.currentTab = 'config'"
                class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
          前往配置
        </button>
      </div>
    </div>

    <div v-else>
      <!-- 状态概览 -->
      <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-6 border">
          <div class="flex items-center justify-between mb-3">
            <div class="text-sm text-gray-600">纠删码状态</div>
            <span class="text-3xl">✅</span>
          </div>
          <div class="text-2xl font-bold text-green-600">运行中</div>
        </div>
        <div class="bg-white rounded-lg shadow p-6 border">
          <div class="flex items-center justify-between mb-3">
            <div class="text-sm text-gray-600">纠删码方案</div>
            <span class="text-3xl">🛡️</span>
          </div>
          <div class="text-2xl font-bold text-blue-600">RS {{ window.ecConfig.k }}+{{ window.ecConfig.m }}</div>
        </div>
        <div class="bg-white rounded-lg shadow p-6 border">
          <div class="flex items-center justify-between mb-3">
            <div class="text-sm text-gray-600">配置磁盘数</div>
            <span class="text-3xl">💾</span>
          </div>
          <div class="text-2xl font-bold text-purple-600">{{ window.ecConfig.disks?.length || 0 }}</div>
        </div>
      </div>

      <!-- 磁盘状态详情 -->
      <div class="bg-white rounded-lg shadow border">
        <div class="p-6 border-b">
          <h4 class="font-bold text-lg">磁盘状态详情</h4>
        </div>
        <div class="overflow-auto">
          <table class="w-full">
            <thead class="bg-gray-50 border-b">
              <tr>
                <th class="text-left p-4 font-semibold text-gray-700">磁盘</th>
                <th class="text-left p-4 font-semibold text-gray-700">总容量</th>
                <th class="text-left p-4 font-semibold text-gray-700">已用</th>
                <th class="text-left p-4 font-semibold text-gray-700">可用</th>
                <th class="text-left p-4 font-semibold text-gray-700">使用率</th>
                <th class="text-left p-4 font-semibold text-gray-700">状态</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="(disk, index) in window.ecConfig.disks" :key="index" class="border-b hover:bg-gray-50">
                <td class="p-4">
                  <div class="flex items-center gap-2">
                    <span class="text-2xl">💾</span>
                    <span class="font-mono font-semibold">{{ disk }}</span>
                  </div>
                </td>
                <td class="p-4">
                  <span v-if="window.capacity && window.capacity.disks[index]">
                    {{ formatBytes(window.capacity.disks[index].total) }}
                  </span>
                  <span v-else class="text-gray-400">-</span>
                </td>
                <td class="p-4">
                  <span v-if="window.capacity && window.capacity.disks[index]">
                    {{ formatBytes(window.capacity.disks[index].total - window.capacity.disks[index].free) }}
                  </span>
                  <span v-else class="text-gray-400">-</span>
                </td>
                <td class="p-4">
                  <span v-if="window.capacity && window.capacity.disks[index]">
                    {{ formatBytes(window.capacity.disks[index].free) }}
                  </span>
                  <span v-else class="text-gray-400">-</span>
                </td>
                <td class="p-4">
                  <div v-if="window.capacity && window.capacity.disks[index]">
                    <div class="text-sm font-semibold mb-1"
                         :class="((window.capacity.disks[index].total - window.capacity.disks[index].free) / window.capacity.disks[index].total * 100) > 80 ? 'text-red-600' : 'text-gray-700'">
                      {{ (((window.capacity.disks[index].total - window.capacity.disks[index].free) / window.capacity.disks[index].total) * 100).toFixed(1) }}%
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                      <div class="h-2 rounded-full"
                           :class="((window.capacity.disks[index].total - window.capacity.disks[index].free) / window.capacity.disks[index].total * 100) > 80 ? 'bg-red-500' : 'bg-blue-500'"
                           :style="{ width: ((window.capacity.disks[index].total - window.capacity.disks[index].free) / window.capacity.disks[index].total * 100) + '%' }">
                      </div>
                    </div>
                  </div>
                  <span v-else class="text-gray-400">-</span>
                </td>
                <td class="p-4">
                  <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">
                    正常
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 恢复标签页 -->
  <div v-else-if="window.currentTab === 'recovery'" class="flex-1 overflow-auto p-6">
    <div v-if="!window.ecConfig" class="flex items-center justify-center h-full">
      <div class="text-center">
        <div class="text-6xl mb-4">⚠️</div>
        <div class="text-xl font-semibold text-gray-700 mb-2">未配置纠删码</div>
        <div class="text-gray-600 mb-6">请先在"配置"标签页配置纠删码</div>
        <button @click="window.currentTab = 'config'"
                class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
          前往配置
        </button>
      </div>
    </div>

    <div v-else class="max-w-3xl mx-auto">
      <div class="bg-white rounded-lg shadow p-8 border text-center">
        <div class="text-6xl mb-4">🔧</div>
        <h3 class="text-2xl font-bold mb-2">数据恢复功能</h3>
        <p class="text-gray-600 mb-6">
          当检测到磁盘损坏或数据丢失时,可以使用纠删码恢复功能重建数据
        </p>

        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6 text-left">
          <div class="flex items-start gap-3">
            <span class="text-2xl">⚠️</span>
            <div class="flex-1">
              <div class="font-semibold text-yellow-900 mb-1">恢复说明</div>
              <div class="text-sm text-yellow-800">
                • 最多可恢复 {{ window.ecConfig.m }} 个磁盘的数据<br>
                • 恢复过程会读取所有健康磁盘的数据<br>
                • 建议在系统负载较低时进行恢复操作
              </div>
            </div>
          </div>
        </div>

        <button class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-semibold">
          开始检测损坏数据
        </button>

        <div class="mt-6 text-sm text-gray-500">
          恢复功能开发中,敬请期待...
        </div>
      </div>
    </div>
  </div>
</div>


          <!-- 系统监控窗口 -->
<div v-if="window.type === 'system-monitor'" class="h-full flex flex-col">
  <div v-if="window.monitorView === 'overview'" class="h-full flex flex-col">
    <div class="px-6 py-4 border-b bg-gradient-to-r from-green-50 to-teal-50">
      <h3 class="text-xl font-bold flex items-center gap-2">
        <span class="text-3xl">📊</span>
        系统监控总览
      </h3>
      <p class="text-sm text-gray-600 mt-1">选择一个节点查看详细信息</p>
    </div>
    <div class="flex-1 overflow-auto p-6 bg-gray-50">
      <div v-if="window.loading" class="flex justify-center items-center h-full">
        <div class="loading"></div> <span class="ml-2 text-gray-600">正在加载节点...</span>
      </div>
      <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div v-for="node in window.nodes" :key="node.id"
             @click="selectNodeForMonitor(window, node)"
             class="bg-white rounded-lg shadow border p-6 cursor-pointer hover:border-blue-500 hover:shadow-lg transition">
          <div class="flex justify-between items-start">
            <h4 class="font-bold text-lg mb-4 text-gray-800">{{ node.name }}</h4>
            <span class="text-3xl">🖥️</span>
          </div>
          <div class="space-y-4">
            <div>
              <div class="text-xs text-gray-600 mb-1">磁盘容量</div>
              <div class="w-full bg-gray-200 rounded-full h-4">
                <div class="h-4 rounded-full flex items-center justify-center text-xs font-semibold"
                     :class="node.disk_usage > 80 ? 'bg-red-500 text-white' : 'bg-blue-500 text-white'"
                     :style="{ width: node.disk_usage + '%' }">
                  {{ node.disk_usage.toFixed(1) }}%
                </div>
              </div>
              <div class="text-xs text-gray-600 mt-1 text-right">
                {{ node.used_storage }} / {{ node.total_storage }} GB
              </div>
            </div>
            <div>
              <div class="text-xs text-gray-600 mb-1">CPU 温度</div>
              <div class="flex items-center gap-2">
                <span class="text-2xl">🌡️</span>
                <span class="text-3xl font-bold"
                      :class="node.cpu_temp > 75 ? 'text-red-600' : 'text-orange-500'">
                  {{ node.cpu_temp.toFixed(1) }}°C
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div v-else-if="window.monitorView === 'detail'" class="h-full flex flex-col">
  <div class="px-6 py-4 border-b bg-gradient-to-r from-green-50 to-teal-50 flex justify-between items-center">
    <div>
      <h3 class="text-xl font-bold flex items-center gap-2">
        <span class="text-3xl">🖥️</span>
        {{ window.title }}
      </h3>
      <p class="text-sm text-gray-600 mt-1">实时监控系统硬件状态</p>
    </div>
    <button @click="returnToMonitorOverview(window)" class="px-4 py-2 bg-white border rounded-lg hover:bg-gray-50 transition">
      &lt; 返回总览
    </button>
  </div>
  <div v-if="window.loading" class="flex-1 flex justify-center items-center">
      <div class="loading"></div> <span class="ml-2 text-gray-600">正在加载详细数据...</span>
  </div>
  <div v-else-if="window.selectedNodeStats" class="flex-1 overflow-auto p-6 bg-gray-50">
   <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
  <!-- CPU信息 -->
  <div class="bg-white rounded-lg shadow border p-4">
    <h4 class="font-semibold mb-4 text-lg flex items-center gap-2">
      <span class="text-2xl">💻</span> CPU
    </h4>
    <div class="space-y-2 text-sm">
      <div class="flex justify-between">
        <span class="text-gray-700">温度</span>
        <span class="font-bold">{{ window.selectedNodeStats.cpu_temp_celsius || '--' }}°C</span>
      </div>
      <div class="flex justify-between">
        <span class="text-gray-700">频率</span>
        <span class="font-bold">{{ window.selectedNodeStats.cpu_freq || '--' }} GHz</span>
      </div>
      <div class="flex justify-between">
        <span class="text-gray-700">功耗</span>
        <span class="font-bold">{{ window.selectedNodeStats.cpu_power || '--' }} W</span>
      </div>
    </div>
  </div>

  <!-- 风扇转速 -->
  <div class="bg-white rounded-lg shadow border p-4">
    <h4 class="font-semibold mb-4 text-lg flex items-center gap-2">
      <span class="text-2xl">💨</span> 风扇转速
    </h4>
    <div class="space-y-2 text-sm">
  <div class="flex justify-between">
    <span class="text-gray-700">转速</span>
    <span class="font-bold text-blue-600">{{ (window.selectedNodeStats.fans && window.selectedNodeStats.fans[0]) ? window.selectedNodeStats.fans[0].value : '--' }} RPM</span>
  </div>
</div>
  </div>

  <!-- 内存使用 -->
<div class="bg-white rounded-lg shadow border p-4">
  <h4 class="font-semibold mb-4 text-lg flex items-center gap-2">
    <span class="text-2xl">🧠</span> 内存
  </h4>
  <div class="space-y-2 text-sm">
    <div class="flex justify-between">
      <span class="text-gray-700">使用率</span>
      <span class="font-bold">{{ window.selectedNodeStats.memory_percent ?? '--' }}%</span>
    </div>
  </div>
</div>

  <!-- 硬盘温度 -->
  <div class="bg-white rounded-lg shadow border p-4">
    <h4 class="font-semibold mb-4 text-lg flex items-center gap-2">
      <span class="text-2xl">💾</span> 硬盘
    </h4>
    <div class="space-y-2 text-sm">
  <div class="flex justify-between">
    <span class="text-gray-700">温度</span>
    <span class="font-bold">{{ (window.selectedNodeStats.disks_temp && window.selectedNodeStats.disks_temp[0]) ? window.selectedNodeStats.disks_temp[0].value : '--' }}°C</span>
  </div>
</div>
  </div>

  <!-- 网络带宽 -->
  <div class="bg-white rounded-lg shadow border p-4">
    <h4 class="font-semibold mb-4 text-lg flex items-center gap-2">
      <span class="text-2xl">🌐</span> 网络带宽
    </h4>
    <div class="grid grid-cols-2 gap-4 text-sm">
      <div class="flex justify-between">
        <span class="text-gray-700">下载</span>
        <span class="font-bold text-green-600">{{ window.selectedNodeStats.network_download !== undefined && window.selectedNodeStats.network_download !== null ? window.selectedNodeStats.network_download : '--' }} MB/s</span>
      </div>
      <div class="flex justify-between">
        <span class="text-gray-700">上传</span>
        <span class="font-bold text-blue-600">{{ window.selectedNodeStats.network_upload !== undefined && window.selectedNodeStats.network_upload !== null ? window.selectedNodeStats.network_upload : '--' }} MB/s</span>
      </div>
    </div>
  </div>
</div>
  </div>
</div>
</div>

        </div>
      </div>

     <div class="taskbar">
  <div class="taskbar-item" @click.stop="toggleStartMenu">
    <span class="text-xl">🚀</span>
    <span class="ml-2 font-semibold">NAS Center</span>
  </div>

  <div v-for="window in windows.filter(w => !w.minimized)"
        :key="window.id"
        @click="focusWindow(window.id)"
        :class="['taskbar-item', { active: window.zIndex === maxZIndex }]">
    <span>{{ window.icon }}</span>
    <span class="ml-2">{{ window.title }}</span>
  </div>

  <div class="ml-auto flex items-center gap-4 text-white text-sm">

    <span>⏰ {{ currentTime }}</span>

    <div v-if="showStartMenu" class="start-menu">
      <div class="start-menu-header">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xl font-bold">NAS Center</div>
            <div class="text-sm opacity-90 mt-1">主控管理中心</div>
          </div>
          <div class="text-3xl">🚀</div>
        </div>
      </div>

      <div class="start-menu-section">
        <div class="start-menu-section-title">快速访问</div>
        <div class="start-menu-item" @click="openNodeManagement(); showStartMenu = false">
          <span class="text-xl">🖥️</span>
          <div class="flex-1">
            <div class="font-semibold">节点管理</div>
            <div class="text-xs opacity-70">管理所有NAS节点</div>
          </div>
        </div>
        <div class="start-menu-item" @click="openSystemMonitor(); showStartMenu = false">
          <span class="text-xl">📊</span>
          <div class="flex-1">
            <div class="font-semibold">系统监控</div>
            <div class="text-xs opacity-70">实时硬件监控</div>
          </div>
        </div>
        <div class="start-menu-item" @click="openSpaceAllocation(); showStartMenu = false">
          <span class="text-xl">📦</span>
          <div class="flex-1">
            <div class="font-semibold">空间分配</div>
            <div class="text-xs opacity-70">跨节点文件分配</div>
          </div>
        </div>
      </div>

      <div class="h-px bg-white/10 my-2"></div>

      <div class="start-menu-section">
        <div class="start-menu-section-title">安全管理</div>
        <div class="start-menu-item" @click="openEncryptionManager(); showStartMenu = false">
          <span class="text-xl">🔐</span>
          <div class="flex-1">
            <div class="font-semibold">加密管理</div>
            <div class="text-xs opacity-70">磁盘和文件加密</div>
          </div>
        </div>
        <div class="start-menu-item" @click="openPermissionSettings(); showStartMenu = false">
          <span class="text-xl">🔒</span>
          <div class="flex-1">
            <div class="font-semibold">权限设置</div>
            <div class="text-xs opacity-70">用户访问控制</div>
          </div>
        </div>
      </div>

      <div class="h-px bg-white/10 my-2"></div>

      <div class="start-menu-section">
        <div class="start-menu-section-title">高级功能</div>
        <div class="start-menu-item" @click="openECConfig(); showStartMenu = false">
          <span class="text-xl">🛡️</span>
          <div class="flex-1">
            <div class="font-semibold">纠删码配置</div>
            <div class="text-xs opacity-70">数据冗余保护</div>
          </div>
        </div>
        <div class="start-menu-item start-menu-item-disabled">
          <span class="text-xl">📡</span>
          <div class="flex-1">
            <div class="font-semibold">远程同步</div>
            <div class="text-xs opacity-70">即将推出</div>
          </div>
        </div>
      </div>

      <div class="h-px bg-white/10 my-2"></div>
      <div class="start-menu-section">
        <div class="start-menu-section-title">
          {{ currentUser?.username || '用户' }} {{ currentUser?.role === 'admin' ? '(管理员)' : '' }}
        </div>

        <div class="start-menu-item" @click="openUserProfile(); showStartMenu = false">
          <span class="text-xl">👤</span>
          <div class="flex-1">
            <div class="font-semibold">个人信息</div>
            <div class="text-xs opacity-70">{{ currentUser?.email || '无邮箱' }}</div>
          </div>
        </div>

        <div class="start-menu-item" @click="openChangePassword(); showStartMenu = false">
          <span class="text-xl">🔑</span>
          <div class="flex-1">
            <div class="font-semibold">修改密码</div>
          </div>
        </div>

        <div v-if="currentUser?.role === 'admin'" class="start-menu-item" @click="openUserManagement(); showStartMenu = false">
          <span class="text-xl">👥</span>
          <div class="flex-1">
            <div class="font-semibold">用户管理</div>
          </div>
        </div>

        <div class="start-menu-item" @click="logout(); showStartMenu = false">
          <span class="text-xl">🚪</span>
          <div class="flex-1">
            <div class="font-semibold" style="color: #f87171;">退出登录</div>
          </div>
        </div>
      </div>
      <div class="h-px bg-white/10 my-2"></div>

      <div class="start-menu-section">
        <div class="start-menu-item" @click="showStartMenu = false">
          <span class="text-xl">ℹ️</span>
          <span>关于系统</span>
        </div>
        <div class="start-menu-item" @click="showStartMenu = false">
          <span class="text-xl">❓</span>
          <span>帮助文档</span>
        </div>
      </div>
    </div>
     </div>

  </div>

   <!-- 节点分组对话框 -->
   <div v-if="showGroupDialog"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[2000]"
        @click.self="closeGroupDialog()">
     <div class="bg-white rounded-lg shadow-xl w-[600px] max-h-[80vh] flex flex-col">
       <!-- 对话框标题 -->
       <div class="flex justify-between items-center p-6 border-b">
         <h3 class="text-xl font-bold">
           {{ groupDialogMode === 'create' ? '创建节点分组' : '编辑节点分组' }}
         </h3>
         <button @click="closeGroupDialog()" class="text-gray-500 hover:text-gray-700 text-2xl">
           ×
         </button>
       </div>

       <!-- 对话框内容 -->
       <div class="flex-1 overflow-auto p-6">
         <!-- 分组图标 -->
         <div class="mb-4">
           <label class="block text-sm font-semibold mb-2">图标</label>
           <div class="flex gap-2">
             <button v-for="icon in ['📁', '📂', '🗂️', '📦', '🏢', '🏠', '🌐', '☁️', '💾', '🖥️']"
                     :key="icon"
                     @click="groupForm.icon = icon"
                     :class="groupForm.icon === icon ? 'bg-blue-500 text-white' : 'bg-gray-100 hover:bg-gray-200'"
                     class="w-12 h-12 rounded-lg text-2xl flex items-center justify-center transition">
               {{ icon }}
             </button>
           </div>
         </div>

         <!-- 分组名称 -->
         <div class="mb-4">
           <label class="block text-sm font-semibold mb-2">分组名称 *</label>
           <input v-model="groupForm.name"
                  type="text"
                  placeholder="例如: 生产环境节点"
                  class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
         </div>

         <!-- 分组描述 -->
         <div class="mb-4">
           <label class="block text-sm font-semibold mb-2">描述 (可选)</label>
           <textarea v-model="groupForm.description"
                     placeholder="简要描述这个分组的用途..."
                     rows="3"
                     class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
         </div>

         <!-- 选择节点 -->
         <div class="mb-4">
           <label class="block text-sm font-semibold mb-2">包含的节点</label>
           <div class="space-y-2 max-h-60 overflow-auto border rounded-lg p-3">
  <label v-for="node in (availableNodes || []).filter(n => n && n.id)" :key="node.id"
         class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
               <input type="checkbox"
                      :value="node.id"
                      v-model="groupForm.nodes"
                      class="w-4 h-4">
               <span class="text-2xl">🖥️</span>
               <div class="flex-1">
                 <div class="font-semibold text-sm">{{ node.name }}</div>
                 <div class="text-xs text-gray-600">{{ node.ip }}:{{ node.port }}</div>
               </div>
             </label>
           </div>
           <div class="text-xs text-gray-600 mt-2">
             已选择 {{ groupForm.nodes.length }} 个节点
           </div>
         </div>
       </div>

       <!-- 对话框按钮 -->
       <div class="flex justify-end gap-3 p-6 border-t">
         <button @click="closeGroupDialog()"
                 class="px-4 py-2 border rounded-lg hover:bg-gray-100">
           取消
         </button>
         <button @click="saveNodeGroup()"
                 class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
           {{ groupDialogMode === 'create' ? '创建' : '保存' }}
         </button>
       </div>
     </div>
   </div>

   <!-- 用户节点访问权限详细编辑对话框 -->
<div v-if="showUserAccessDialog"
     class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[2000]"
     @click.self="closeUserAccessDialog()">
  <div class="bg-white rounded-lg shadow-xl w-[700px] max-h-[80vh] flex flex-col">
    <!-- 对话框标题 -->
    <div class="flex justify-between items-center p-6 border-b">
      <h3 class="text-xl font-bold">
        编辑节点访问权限 - {{ currentEditUser?.username }}
      </h3>
      <button @click="closeUserAccessDialog()" class="text-gray-500 hover:text-gray-700 text-2xl">
        ×
      </button>
    </div>

    <!-- 对话框内容 -->
    <div class="flex-1 overflow-auto p-6">
      <!-- 访问类型选择 -->
      <div class="mb-6">
        <label class="block text-sm font-semibold mb-3">访问类型</label>
        <div class="space-y-2">
          <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50"
                 :class="userAccessForm.type === 'all' ? 'border-blue-500 bg-blue-50' : ''">
            <input type="radio"
                   v-model="userAccessForm.type"
                   value="all"
                   class="w-4 h-4">
            <div class="flex-1">
              <div class="font-semibold">✓ 所有节点</div>
              <div class="text-xs text-gray-600">用户可以访问所有节点</div>
            </div>
          </label>

          <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50"
                 :class="userAccessForm.type === 'groups' ? 'border-blue-500 bg-blue-50' : ''">
            <input type="radio"
                   v-model="userAccessForm.type"
                   value="groups"
                   class="w-4 h-4">
            <div class="flex-1">
              <div class="font-semibold">📁 按分组访问</div>
              <div class="text-xs text-gray-600">用户只能访问指定分组中的节点</div>
            </div>
          </label>

          <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50"
                 :class="userAccessForm.type === 'custom' ? 'border-blue-500 bg-blue-50' : ''">
            <input type="radio"
                   v-model="userAccessForm.type"
                   value="custom"
                   class="w-4 h-4">
            <div class="flex-1">
              <div class="font-semibold">🎯 自定义节点</div>
              <div class="text-xs text-gray-600">手动选择用户可以访问的节点</div>
            </div>
          </label>
        </div>
      </div>

      <!-- 按分组访问 - 选择分组 -->
      <div v-if="userAccessForm.type === 'groups'" class="mb-6">
        <label class="block text-sm font-semibold mb-3">允许访问的分组</label>
        <div v-if="(windows.find(w => w.type === 'permissions')?.groups || []).length > 0" class="space-y-2 max-h-60 overflow-auto border rounded-lg p-3">
          <label v-for="group in windows.find(w => w.type === 'permissions')?.groups || []"
                 :key="group.id"
                 class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
            <input type="checkbox"
                   :value="group.id"
                   v-model="userAccessForm.allowed_groups"
                   class="w-4 h-4">
            <span class="text-2xl">{{ group.icon }}</span>
            <div class="flex-1">
              <div class="font-semibold text-sm">{{ group.name }}</div>
              <div class="text-xs text-gray-600">
                包含 {{ group.nodes.length }} 个节点
              </div>
            </div>
          </label>
        </div>
        <div v-else class="text-sm text-gray-500 text-center py-4 border rounded-lg">
          还没有创建任何分组,请先在"节点分组"标签页创建分组
        </div>
        <div class="text-xs text-gray-600 mt-2">
         已选择 {{ (userAccessForm.allowed_groups || []).length }} 个分组
        </div>
      </div>

      <!-- 自定义节点 - 选择节点 -->
      <div v-if="userAccessForm.type === 'custom'" class="mb-6">
        <label class="block text-sm font-semibold mb-3">允许访问的节点</label>
        <div class="space-y-2 max-h-60 overflow-auto border rounded-lg p-3">
         <label v-for="node in (availableNodes || []).filter(n => n && n.id)" :key="node.id"
         class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
            <input type="checkbox"
                   :value="node.id"
                   v-model="userAccessForm.allowed_nodes"
                   class="w-4 h-4">
            <span class="text-2xl">🖥️</span>
            <div class="flex-1">
              <div class="font-semibold text-sm">{{ node.name }}</div>
              <div class="text-xs text-gray-600">{{ node.ip }}:{{ node.port }}</div>
            </div>
          </label>
        </div>
        <div class="text-xs text-gray-600 mt-2">
         已选择 {{ (userAccessForm.allowed_nodes || []).length }} 个节点
        </div>
      </div>

      <!-- 拒绝访问的节点(可选) -->
      <div v-if="userAccessForm.type !== 'custom'" class="mb-6">
        <label class="block text-sm font-semibold mb-3">
          明确拒绝访问的节点 (可选)
        </label>
        <details class="border rounded-lg">
          <summary class="px-3 py-2 cursor-pointer hover:bg-gray-50 text-sm font-medium">
            点击展开黑名单设置
          </summary>
          <div class="space-y-2 max-h-60 overflow-auto border rounded-lg p-3">
  <label v-for="node in (availableNodes || []).filter(n => n && n.id)" :key="node.id"
         class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
              <input type="checkbox"
                     :value="node.id"
                     v-model="userAccessForm.denied_nodes"
                     class="w-4 h-4">
              <span class="text-2xl">🖥️</span>
              <div class="flex-1">
                <div class="font-semibold text-sm">{{ node.name }}</div>
                <div class="text-xs text-gray-600">{{ node.ip }}:{{ node.port }}</div>
              </div>
            </label>
          </div>
        </details>
      </div>
    </div>

    <!-- 对话框按钮 -->
    <div class="flex justify-end gap-3 p-6 border-t">
      <button @click="closeUserAccessDialog()"
              class="px-4 py-2 border rounded-lg hover:bg-gray-100">
        取消
      </button>
      <button @click="saveUserNodeAccess()"
              class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
        保存
      </button>
    </div>
  </div>
</div>

      </div></div>



  <script src="app.js"></script>

</body>
</html>
```