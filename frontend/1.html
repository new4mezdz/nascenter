<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NAS Center 管理系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    /* 桌面背景 */
    .desktop {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      position: relative;
      user-select: none;
    }

    /* 桌面图标 */
    .desktop-icon {
      width: 90px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      padding: 8px;
    }

    .desktop-icon:hover {
      transform: translateY(-2px);
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
    }

    /* 窗口系统 */
    .window {
      position: absolute;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
      min-width: 400px;
      min-height: 300px;
      display: flex;
      flex-direction: column;
    }

    .window.maximized {
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: calc(100vh - 50px) !important;
      border-radius: 0;
    }

    .window-header {
      background: linear-gradient(180deg, #f7f7f7 0%, #e8e8e8 100%);
      padding: 12px 16px;
      cursor: move;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ddd;
    }

    .window-controls button {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: none;
      margin-left: 8px;
      cursor: pointer;
    }

    .window-controls .close { background: #ff5f57; }
    .window-controls .minimize { background: #ffbd2e; }
    .window-controls .maximize { background: #28ca42; }

    .window-content {
      flex: 1;
      overflow: auto;
    }

    /* 任务栏 */
    .taskbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 50px;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      padding: 0 20px;
      z-index: 1000;
    }

    .taskbar-item {
      height: 40px;
      padding: 0 16px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      margin-right: 8px;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s;
      color: white;
    }

    .taskbar-item:hover {
      background: rgba(255,255,255,0.2);
    }

    .taskbar-item.active {
      background: rgba(255,255,255,0.3);
    }

    /* 加载状态 */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* 动画 */
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .window {
      animation: fadeIn 0.2s ease-out;
    }

    /* 网格视图 */
    .icon-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, 90px);
      gap: 20px;
      padding: 20px;
    }

    /* 滚动条美化 */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  </style>
</head>
<body>

  <div id="app">
    <!-- 桌面环境 -->
    <div class="desktop fixed inset-0" @click="closeAllMenus">

      <!-- 桌面图标区域 -->
      <div class="icon-grid p-8">
        <!-- 节点管理 -->
        <div class="desktop-icon" @dblclick="openNodeManagement">
          <div class="w-16 h-16 mx-auto mb-2 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-4xl">
            🖥️
          </div>
          <div class="text-white text-xs font-semibold drop-shadow-lg">节点管理</div>
        </div>

        <!-- 内网穿透 -->
        <div class="desktop-icon" @dblclick="openIntranetAccess">
          <div class="w-16 h-16 mx-auto mb-2 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-4xl">
            🌐
          </div>
          <div class="text-white text-xs font-semibold drop-shadow-lg">内网穿透</div>
        </div>

        <!-- 用户权限设置 -->
        <div class="desktop-icon" @dblclick="openPermissionSettings">
          <div class="w-16 h-16 mx-auto mb-2 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-4xl">
            🔐
          </div>
          <div class="text-white text-xs font-semibold drop-shadow-lg">权限设置</div>
        </div>

        <!-- 纠删码配置 -->
        <div class="desktop-icon" @dblclick="openECConfig">
          <div class="w-16 h-16 mx-auto mb-2 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-4xl">
            🛡️
          </div>
          <div class="text-white text-xs font-semibold drop-shadow-lg">纠删码配置</div>
        </div>

        <!-- 系统监控 -->
        <div class="desktop-icon" @dblclick="openSystemMonitor">
          <div class="w-16 h-16 mx-auto mb-2 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-4xl">
            📊
          </div>
          <div class="text-white text-xs font-semibold drop-shadow-lg">系统监控</div>
        </div>
      </div>

      <!-- 窗口容器 -->
      <div v-for="window in windows" :key="window.id"
           :class="['window', { maximized: window.maximized }]"
           :style="window.maximized ? {} : {
             top: window.y + 'px',
             left: window.x + 'px',
             width: window.width + 'px',
             height: window.height + 'px',
             zIndex: window.zIndex,
             display: window.minimized ? 'none' : 'flex'
           }"
           @mousedown="focusWindow(window.id)">

        <!-- 窗口标题栏 -->
        <div class="window-header" @mousedown="startDrag($event, window)">
          <div class="flex items-center gap-2">
            <span class="text-2xl">{{ window.icon }}</span>
            <span class="font-semibold text-sm">{{ window.title }}</span>
          </div>
          <div class="window-controls flex">
            <button class="minimize" @click.stop="minimizeWindow(window.id)"></button>
            <button class="maximize" @click.stop="toggleMaximize(window.id)"></button>
            <button class="close" @click.stop="closeWindow(window.id)"></button>
          </div>
        </div>

        <!-- 窗口内容 -->
        <div class="window-content" style="padding: 0; overflow: hidden;">

          <!-- 节点管理窗口 -->
          <div v-if="window.type === 'nodes'" class="h-full flex flex-col">
            <!-- 标题栏 -->
            <div class="px-6 py-4 border-b bg-gradient-to-r from-blue-50 to-purple-50">
              <div class="flex justify-between items-center">
                <div>
                  <h3 class="text-xl font-bold flex items-center gap-2">
                    <span class="text-3xl">🖥️</span>
                    节点管理
                  </h3>
                  <p class="text-sm text-gray-600 mt-1">管理和监控所有 NAS 节点</p>
                </div>
                <button @click="refreshNodes(window)"
                        class="px-4 py-2 bg-white border rounded-lg hover:bg-gray-50 transition flex items-center gap-2">
                  <span v-if="window.loading" class="loading"></span>
                  <span v-else>🔄</span>
                  刷新
                </button>
              </div>
            </div>

            <!-- 统计卡片 -->
            <div v-if="window.stats" class="grid grid-cols-4 gap-4 p-6 bg-gray-50">
              <div class="bg-white rounded-lg shadow p-4 border">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-xs text-gray-600 mb-1">总节点</div>
                    <div class="text-2xl font-bold text-blue-600">{{ window.stats.total }}</div>
                  </div>
                  <div class="text-4xl">🖥️</div>
                </div>
              </div>
              <div class="bg-white rounded-lg shadow p-4 border">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-xs text-gray-600 mb-1">在线</div>
                    <div class="text-2xl font-bold text-green-600">{{ window.stats.online }}</div>
                  </div>
                  <div class="text-4xl">✅</div>
                </div>
              </div>
              <div class="bg-white rounded-lg shadow p-4 border">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-xs text-gray-600 mb-1">离线</div>
                    <div class="text-2xl font-bold text-red-600">{{ window.stats.offline }}</div>
                  </div>
                  <div class="text-4xl">❌</div>
                </div>
              </div>
              <div class="bg-white rounded-lg shadow p-4 border">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-xs text-gray-600 mb-1">警告</div>
                    <div class="text-2xl font-bold text-yellow-600">{{ window.stats.warning }}</div>
                  </div>
                  <div class="text-4xl">⚠️</div>
                </div>
              </div>
            </div>

            <!-- 节点列表 -->
            <div class="flex-1 overflow-auto p-6 bg-gray-50">
              <div class="bg-white rounded-lg shadow border">
                <table class="w-full">
                  <thead class="bg-gray-50 border-b">
                    <tr>
                      <th class="text-left p-4 font-semibold text-gray-700">节点名称</th>
                      <th class="text-left p-4 font-semibold text-gray-700">地址</th>
                      <th class="text-left p-4 font-semibold text-gray-700">状态</th>
                      <th class="text-left p-4 font-semibold text-gray-700">CPU</th>
                      <th class="text-left p-4 font-semibold text-gray-700">内存</th>
                      <th class="text-left p-4 font-semibold text-gray-700">磁盘</th>
                      <th class="text-left p-4 font-semibold text-gray-700">操作</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="node in window.nodes" :key="node.id"
                        class="border-b hover:bg-gray-50">
                      <td class="p-4">
                        <div class="font-semibold text-gray-800">{{ node.name }}</div>
                        <div class="text-xs text-gray-500">{{ node.id }}</div>
                      </td>
                      <td class="p-4 text-sm">{{ node.ip }}:{{ node.port }}</td>
                      <td class="p-4">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold"
                              :class="getStatusClass(node.status)">
                          {{ getStatusText(node.status) }}
                        </span>
                      </td>
                      <td class="p-4">
                        <span v-if="node.status !== 'offline'" class="text-sm font-semibold"
                              :class="node.cpu_usage > 80 ? 'text-red-600' : 'text-gray-700'">
                          {{ node.cpu_usage.toFixed(1) }}%
                        </span>
                        <span v-else class="text-sm text-gray-400">-</span>
                      </td>
                      <td class="p-4">
                        <span v-if="node.status !== 'offline'" class="text-sm font-semibold"
                              :class="node.memory_usage > 80 ? 'text-red-600' : 'text-gray-700'">
                          {{ node.memory_usage.toFixed(1) }}%
                        </span>
                        <span v-else class="text-sm text-gray-400">-</span>
                      </td>
                      <td class="p-4">
                        <span v-if="node.status !== 'offline'" class="text-sm font-semibold"
                              :class="node.disk_usage > 80 ? 'text-red-600' : 'text-gray-700'">
                          {{ node.disk_usage.toFixed(1) }}%
                        </span>
                        <span v-else class="text-sm text-gray-400">-</span>
                      </td>
                      <td class="p-4">
                        <div class="flex gap-2">
                          <button @click="viewNodeDisks(window, node)"
                                  class="px-3 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">
                            💾 磁盘
                          </button>
                          <button @click="viewNodeDetail(window, node)"
                                  class="px-3 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600">
                            📊 详情
                          </button>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- 节点磁盘详情弹窗 -->
            <div v-if="window.selectedNodeDisks"
                 @click="window.selectedNodeDisks = null"
                 class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div @click.stop class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-[80vh] overflow-hidden">
                <div class="px-6 py-4 border-b bg-gradient-to-r from-blue-500 to-purple-600 text-white">
                  <h3 class="text-xl font-bold">{{ window.selectedNodeDisks.name }} - 磁盘信息</h3>
                </div>
                <div class="p-6 overflow-y-auto max-h-[60vh]">
                  <div class="space-y-4">
                    <div v-for="(disk, index) in window.selectedNodeDisks.disks" :key="index"
                         class="border rounded-lg p-4 bg-gray-50">
                      <div class="flex justify-between items-start mb-3">
                        <div>
                          <div class="font-bold text-lg">{{ disk.mount }}</div>
                          <div class="text-sm text-gray-600">容量: {{ disk.total }} GB</div>
                        </div>
                        <span v-if="disk.ec_scheme" class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">
                          🛡️ {{ disk.ec_scheme }}
                        </span>
                      </div>
                      <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="h-4 rounded-full flex items-center justify-center text-xs text-white font-semibold"
                             :class="disk.usage > 90 ? 'bg-red-500' : disk.usage > 70 ? 'bg-yellow-500' : 'bg-green-500'"
                             :style="{ width: disk.usage + '%' }">
                          {{ disk.usage }}%
                        </div>
                      </div>
                      <div class="flex justify-between text-xs text-gray-600 mt-2">
                        <span>已用: {{ disk.used }} GB</span>
                        <span>可用: {{ disk.free }} GB</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="px-6 py-4 border-t bg-gray-50 flex justify-end">
                  <button @click="window.selectedNodeDisks = null"
                          class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                    关闭
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- 内网穿透窗口 -->
          <div v-else-if="window.type === 'intranet'" class="h-full flex flex-col overflow-hidden">
            <div class="px-6 py-4 border-b bg-gradient-to-r from-green-50 to-blue-50">
              <h3 class="text-xl font-bold flex items-center gap-2">
                <span class="text-3xl">🌐</span>
                内网穿透
              </h3>
              <p class="text-sm text-gray-600 mt-1">通过穿透服务远程访问内网节点</p>
            </div>

            <div class="flex-1 overflow-auto p-6">
              <!-- 穿透状态 -->
              <div class="bg-white rounded-lg shadow border p-6 mb-6">
                <h4 class="font-semibold text-lg mb-4">穿透服务状态</h4>
                <div class="grid grid-cols-3 gap-4">
                  <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                    <div class="text-sm text-gray-600 mb-1">服务状态</div>
                    <div class="text-xl font-bold text-green-600 flex items-center gap-2">
                      <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                      运行中
                    </div>
                  </div>
                  <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <div class="text-sm text-gray-600 mb-1">活跃连接</div>
                    <div class="text-xl font-bold text-blue-600">{{ window.activeConnections || 3 }}</div>
                  </div>
                  <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                    <div class="text-sm text-gray-600 mb-1">今日流量</div>
                    <div class="text-xl font-bold text-purple-600">2.3 GB</div>
                  </div>
                </div>
              </div>

              <!-- 节点访问列表 -->
              <div class="bg-white rounded-lg shadow border">
                <div class="px-6 py-4 border-b">
                  <h4 class="font-semibold">节点访问列表</h4>
                </div>
                <table class="w-full">
                  <thead class="bg-gray-50 border-b">
                    <tr>
                      <th class="text-left p-4 font-semibold text-gray-700">节点名称</th>
                      <th class="text-left p-4 font-semibold text-gray-700">内网地址</th>
                      <th class="text-left p-4 font-semibold text-gray-700">外网地址</th>
                      <th class="text-left p-4 font-semibold text-gray-700">状态</th>
                      <th class="text-left p-4 font-semibold text-gray-700">操作</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="tunnel in window.tunnels" :key="tunnel.id" class="border-b hover:bg-gray-50">
                      <td class="p-4">
                        <div class="font-semibold">{{ tunnel.name }}</div>
                      </td>
                      <td class="p-4 text-sm font-mono">{{ tunnel.localAddr }}</td>
                      <td class="p-4 text-sm font-mono text-blue-600">{{ tunnel.publicAddr }}</td>
                      <td class="p-4">
                        <span :class="tunnel.active ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'"
                              class="px-3 py-1 rounded-full text-xs font-semibold">
                          {{ tunnel.active ? '🟢 已连接' : '⚪ 未连接' }}
                        </span>
                      </td>
                      <td class="p-4">
                        <button @click="openTunnel(tunnel)"
                                class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
                          🔗 访问
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- 权限设置窗口 -->
          <div v-else-if="window.type === 'permission'" class="h-full flex flex-col overflow-hidden">
            <div class="px-6 py-4 border-b bg-gradient-to-r from-purple-50 to-pink-50">
              <h3 class="text-xl font-bold flex items-center gap-2">
                <span class="text-3xl">🔐</span>
                用户权限设置
              </h3>
              <p class="text-sm text-gray-600 mt-1">配置用户对节点和磁盘的访问权限</p>
            </div>

            <div class="flex-1 overflow-auto p-6">
              <!-- 节点权限 -->
              <div class="bg-white rounded-lg shadow border mb-6">
                <div class="px-6 py-4 border-b">
                  <h4 class="font-semibold">节点访问权限</h4>
                </div>
                <div class="p-6">
                  <table class="w-full">
                    <thead class="bg-gray-50">
                      <tr>
                        <th class="text-left p-3 font-semibold text-gray-700">节点</th>
                        <th class="text-center p-3 font-semibold text-gray-700">可见</th>
                        <th class="text-center p-3 font-semibold text-gray-700">只读</th>
                        <th class="text-center p-3 font-semibold text-gray-700">读写</th>
                        <th class="text-center p-3 font-semibold text-gray-700">管理</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr v-for="node in window.permissionNodes" :key="node.id" class="border-b">
                        <td class="p-3">
                          <div class="font-semibold">{{ node.name }}</div>
                          <div class="text-xs text-gray-500">{{ node.ip }}</div>
                        </td>
                        <td class="p-3 text-center">
                          <input type="checkbox" v-model="node.permissions.visible" class="w-4 h-4">
                        </td>
                        <td class="p-3 text-center">
                          <input type="radio" :name="'perm-' + node.id" v-model="node.permissions.level" value="readonly" class="w-4 h-4">
                        </td>
                        <td class="p-3 text-center">
                          <input type="radio" :name="'perm-' + node.id" v-model="node.permissions.level" value="readwrite" class="w-4 h-4">
                        </td>
                        <td class="p-3 text-center">
                          <input type="radio" :name="'perm-' + node.id" v-model="node.permissions.level" value="admin" class="w-4 h-4">
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- 磁盘隐藏设置 -->
              <div class="bg-white rounded-lg shadow border">
                <div class="px-6 py-4 border-b">
                  <h4 class="font-semibold">磁盘可见性设置</h4>
                </div>
                <div class="p-6">
                  <div class="space-y-4">
                    <div v-for="disk in window.diskVisibility" :key="disk.id"
                         class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border">
                      <div>
                        <div class="font-semibold">{{ disk.node }} - {{ disk.mount }}</div>
                        <div class="text-sm text-gray-600">{{ disk.size }} GB</div>
                      </div>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <span class="text-sm">{{ disk.visible ? '🟢 可见' : '🔴 隐藏' }}</span>
                        <input type="checkbox" v-model="disk.visible" class="w-5 h-5">
                      </label>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 保存按钮 -->
              <div class="mt-6 flex justify-end">
                <button @click="savePermissions(window)"
                        class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                  💾 保存设置
                </button>
              </div>
            </div>
          </div>

          <!-- 纠删码配置窗口 -->
          <div v-else-if="window.type === 'ec'" class="h-full flex flex-col overflow-hidden">
            <div class="px-6 py-4 border-b bg-gradient-to-r from-orange-50 to-red-50">
              <h3 class="text-xl font-bold flex items-center gap-2">
                <span class="text-3xl">🛡️</span>
                纠删码配置
              </h3>
              <p class="text-sm text-gray-600 mt-1">配置数据保护和冗余策略</p>
            </div>

            <div class="flex-1 overflow-auto p-6">
              <!-- 当前状态 -->
              <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded mb-6">
                <div class="flex items-start gap-3">
                  <span class="text-2xl">ℹ️</span>
                  <div>
                    <h4 class="font-semibold text-blue-900 mb-1">什么是纠删码?</h4>
                    <p class="text-sm text-blue-800">纠删码(Erasure Coding)是一种数据保护技术,可以在部分硬盘损坏时恢复数据。配置后,数据会被分散存储在多个硬盘上。</p>
                  </div>
                </div>
              </div>

              <!-- 配置状态 -->
              <div class="bg-white rounded-lg shadow border p-6 mb-6">
                <h4 class="font-semibold text-lg mb-4">当前配置状态</h4>
                <div v-if="window.ecConfig.isConfigured">
                  <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                      <div class="text-sm text-gray-600 mb-1">配置方案</div>
                      <div class="text-lg font-bold text-green-700">
                        Reed-Solomon ({{ window.ecConfig.k }}+{{ window.ecConfig.m }})
                      </div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                      <div class="text-sm text-gray-600 mb-1">参与磁盘</div>
                      <div class="text-lg font-bold text-blue-700">{{ window.ecConfig.diskCount }} 个</div>
                    </div>
                    <div :class="window.ecConfig.healthy ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'"
                         class="p-4 rounded-lg border">
                      <div class="text-sm text-gray-600 mb-1">系统状态</div>
                      <div class="text-lg font-bold" :class="window.ecConfig.healthy ? 'text-green-700' : 'text-red-700'">
                        {{ window.ecConfig.healthy ? '✅ 健康' : '⚠️ 异常' }}
                      </div>
                    </div>
                  </div>
                  <button @click="reconfigureEC(window)"
                          class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
                    ⚙️ 重新配置
                  </button>
                </div>
                <div v-else class="text-center py-8">
                  <p class="text-gray-500 mb-4">尚未配置纠删码</p>
                  <button @click="startECConfig(window)"
                          class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                    🚀 开始配置
                  </button>
                </div>
              </div>

              <!-- 配置向导 -->
              <div v-if="window.showConfigWizard" class="bg-white rounded-lg shadow border p-6">
                <h4 class="font-semibold text-lg mb-4">纠删码配置向导</h4>

                <!-- 步骤1: 选择方案 -->
                <div class="mb-6">
                  <label class="block text-sm font-medium text-gray-700 mb-2">选择纠删码方案</label>
                  <div class="grid grid-cols-3 gap-4">
                    <div v-for="scheme in window.ecSchemes" :key="scheme.name"
                         @click="window.selectedScheme = scheme"
                         :class="window.selectedScheme?.name === scheme.name ? 'border-blue-500 bg-blue-50' : 'border-gray-200'"
                         class="border-2 rounded-lg p-4 cursor-pointer hover:border-blue-400 transition">
                      <div class="font-bold text-lg mb-2">{{ scheme.name }}</div>
                      <div class="text-sm text-gray-600 mb-2">{{ scheme.description }}</div>
                      <div class="text-xs text-gray-500">
                        最多容忍 {{ scheme.m }} 个磁盘故障
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 步骤2: 选择磁盘 -->
                <div class="mb-6">
                  <label class="block text-sm font-medium text-gray-700 mb-2">选择参与的磁盘</label>
                  <div class="space-y-2">
                    <div v-for="disk in window.availableDisks" :key="disk.id"
                         class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border">
                      <input type="checkbox" v-model="disk.selected" class="w-5 h-5">
                      <div class="flex-1">
                        <div class="font-semibold">{{ disk.node }} - {{ disk.mount }}</div>
                        <div class="text-sm text-gray-600">{{ disk.size }} GB 可用</div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 操作按钮 -->
                <div class="flex justify-end gap-3">
                  <button @click="window.showConfigWizard = false"
                          class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                    取消
                  </button>
                  <button @click="applyECConfig(window)"
                          class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                    应用配置
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- 系统监控窗口 -->
          <div v-else-if="window.type === 'monitor'" class="h-full flex flex-col overflow-hidden">
            <div class="px-6 py-4 border-b bg-gradient-to-r from-indigo-50 to-blue-50">
              <h3 class="text-xl font-bold flex items-center gap-2">
                <span class="text-3xl">📊</span>
                系统监控
              </h3>
              <p class="text-sm text-gray-600 mt-1">实时监控整体系统运行状态</p>
            </div>

            <div class="flex-1 overflow-auto p-6 bg-gray-50">
              <!-- 总览统计 -->
              <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-5 rounded-lg shadow">
                  <div class="text-sm opacity-90 mb-1">总存储容量</div>
                  <div class="text-3xl font-bold">{{ window.totalStorage }} TB</div>
                </div>
                <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-5 rounded-lg shadow">
                  <div class="text-sm opacity-90 mb-1">已用容量</div>
                  <div class="text-3xl font-bold">{{ window.usedStorage }} TB</div>
                </div>
                <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-5 rounded-lg shadow">
                  <div class="text-sm opacity-90 mb-1">平均CPU</div>
                  <div class="text-3xl font-bold">{{ window.avgCpu }}%</div>
                </div>
                <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-5 rounded-lg shadow">
                  <div class="text-sm opacity-90 mb-1">网络流量</div>
                  <div class="text-3xl font-bold">{{ window.networkTraffic }} MB/s</div>
                </div>
              </div>

              <!-- 实时图表 -->
              <div class="bg-white rounded-lg shadow border p-6">
                <h4 class="font-semibold mb-4">性能趋势</h4>
                <div class="h-64 flex items-center justify-center border-2 border-dashed rounded-lg">
                  <div class="text-center text-gray-400">
                    <div class="text-4xl mb-2">📈</div>
                    <p>图表区域 (可接入真实监控数据)</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- 任务栏 -->
      <div class="taskbar">
        <!-- 开始按钮 -->
        <div class="taskbar-item">
          <span class="text-xl">🚀</span>
          <span class="ml-2 font-semibold">NAS Center</span>
        </div>

        <!-- 窗口列表 -->
        <div v-for="window in windows.filter(w => !w.minimized)"
             :key="window.id"
             @click="focusWindow(window.id)"
             :class="['taskbar-item', { active: window.zIndex === maxZIndex }]">
          <span>{{ window.icon }}</span>
          <span class="ml-2">{{ window.title }}</span>
        </div>

        <!-- 右侧信息 -->
        <div class="ml-auto flex items-center gap-4 text-white text-sm">
          <span>⏰ {{ currentTime }}</span>
        </div>
      </div>

    </div>
  </div>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          windows: [],
          nextWindowId: 1,
          maxZIndex: 100,
          currentTime: '',
          dragWindow: null,
          dragOffset: { x: 0, y: 0 },
          apiBaseUrl: 'http://localhost:8080'
        };
      },
      mounted() {
        this.updateTime();
        setInterval(() => this.updateTime(), 1000);

        // 自动打开节点管理
        this.openNodeManagement();
      },
      methods: {
        updateTime() {
          const now = new Date();
          this.currentTime = now.toLocaleTimeString('zh-CN');
        },

        createWindow(config) {
          const win = {
            id: this.nextWindowId++,
            x: 100 + (this.windows.length * 30),
            y: 50 + (this.windows.length * 30),
            width: config.width || 900,
            height: config.height || 600,
            zIndex: this.maxZIndex++,
            maximized: false,
            minimized: false,
            ...config
          };
          this.windows.push(win);
          return win;
        },

        closeWindow(id) {
          const index = this.windows.findIndex(w => w.id === id);
          if (index !== -1) {
            this.windows.splice(index, 1);
          }
        },

        minimizeWindow(id) {
          const win = this.windows.find(w => w.id === id);
          if (win) win.minimized = true;
        },

        toggleMaximize(id) {
          const win = this.windows.find(w => w.id === id);
          if (win) win.maximized = !win.maximized;
        },

        focusWindow(id) {
          const win = this.windows.find(w => w.id === id);
          if (win) {
            win.minimized = false;
            win.zIndex = this.maxZIndex++;
          }
        },

        startDrag(event, window) {
          if (window.maximized) return;
          this.dragWindow = window;
          this.dragOffset.x = event.clientX - window.x;
          this.dragOffset.y = event.clientY - window.y;

          document.addEventListener('mousemove', this.onDrag);
          document.addEventListener('mouseup', this.stopDrag);
        },

        onDrag(event) {
          if (!this.dragWindow) return;
          this.dragWindow.x = event.clientX - this.dragOffset.x;
          this.dragWindow.y = event.clientY - this.dragOffset.y;
        },

        stopDrag() {
          this.dragWindow = null;
          document.removeEventListener('mousemove', this.onDrag);
          document.removeEventListener('mouseup', this.stopDrag);
        },

        closeAllMenus() {
          // 关闭所有弹出菜单
        },

        // ============ 节点管理 ============
        openNodeManagement() {
          const win = this.createWindow({
            type: 'nodes',
            title: '节点管理',
            icon: '🖥️',
            width: 1200,
            height: 700,
            nodes: [],
            stats: null,
            loading: false,
            selectedNodeDisks: null
          });
          this.loadNodesData(win);
        },

        async loadNodesData(window) {
          window.loading = true;
          try {
            const nodesRes = await axios.get(`${this.apiBaseUrl}/api/nodes`);
            window.nodes = nodesRes.data;

            const statsRes = await axios.get(`${this.apiBaseUrl}/api/stats`);
            window.stats = {
              total: statsRes.data.total_nodes,
              online: statsRes.data.online_nodes,
              offline: statsRes.data.offline_nodes,
              warning: statsRes.data.warning_nodes
            };
          } catch (error) {
            console.error('加载失败,使用模拟数据');
            this.loadMockNodesData(window);
          } finally {
            window.loading = false;
          }
        },

        loadMockNodesData(window) {
          window.nodes = [
            { id: "node-1", name: "NAS-主节点", ip: "192.168.1.100", port: 8000, status: "online",
              cpu_usage: 45.5, memory_usage: 62.3, disk_usage: 78.9, total_storage: 2000,
              used_storage: 1578, network_speed: 125.6 },
            { id: "node-2", name: "NAS-备份节点", ip: "192.168.1.101", port: 8000, status: "online",
              cpu_usage: 23.8, memory_usage: 45.2, disk_usage: 56.4, total_storage: 4000,
              used_storage: 2256, network_speed: 89.3 },
            { id: "node-3", name: "NAS-测试节点", ip: "192.168.1.102", port: 8000, status: "warning",
              cpu_usage: 87.2, memory_usage: 91.5, disk_usage: 45.3, total_storage: 1000,
              used_storage: 453, network_speed: 45.7 },
            { id: "node-4", name: "NAS-离线节点", ip: "192.168.1.103", port: 8000, status: "offline",
              cpu_usage: 0, memory_usage: 0, disk_usage: 0, total_storage: 2000,
              used_storage: 0, network_speed: 0 }
          ];

          window.stats = {
            total: 4,
            online: 2,
            offline: 1,
            warning: 1
          };
        },

        refreshNodes(window) {
          this.loadNodesData(window);
        },

        viewNodeDisks(window, node) {
          // 模拟磁盘数据
          window.selectedNodeDisks = {
            name: node.name,
            disks: [
              { mount: '/mnt/disk1', total: 1000, used: 789, free: 211, usage: 78.9, ec_scheme: 'RS(4+2)' },
              { mount: '/mnt/disk2', total: 1000, used: 450, free: 550, usage: 45.0, ec_scheme: null },
              { mount: '/mnt/ec_volume', total: 4000, used: 2340, free: 1660, usage: 58.5, ec_scheme: 'RS(8+4)' }
            ]
          };
        },

        viewNodeDetail(window, node) {
          alert('查看节点详情: ' + node.name);
        },

        getStatusClass(status) {
          const classes = {
            online: 'bg-green-100 text-green-700 border border-green-300',
            offline: 'bg-gray-100 text-gray-700 border border-gray-300',
            warning: 'bg-yellow-100 text-yellow-700 border border-yellow-300'
          };
          return classes[status] || classes.offline;
        },

        getStatusText(status) {
          const texts = { online: '在线', offline: '离线', warning: '警告' };
          return texts[status] || '未知';
        },

        // ============ 内网穿透 ============
        openIntranetAccess() {
          this.createWindow({
            type: 'intranet',
            title: '内网穿透',
            icon: '🌐',
            width: 1000,
            height: 600,
            activeConnections: 3,
            tunnels: [
              { id: 1, name: 'NAS-主节点', localAddr: '192.168.1.100:8000',
                publicAddr: 'nas1.example.com:443', active: true },
              { id: 2, name: 'NAS-备份节点', localAddr: '192.168.1.101:8000',
                publicAddr: 'nas2.example.com:443', active: true },
              { id: 3, name: 'NAS-测试节点', localAddr: '192.168.1.102:8000',
                publicAddr: 'nas3.example.com:443', active: false }
            ]
          });
        },

        openTunnel(tunnel) {
          window.open('http://' + tunnel.publicAddr, '_blank');
        },

        // ============ 权限设置 ============
        openPermissionSettings() {
          this.createWindow({
            type: 'permission',
            title: '权限设置',
            icon: '🔐',
            width: 1000,
            height: 700,
            permissionNodes: [
              { id: 'node-1', name: 'NAS-主节点', ip: '192.168.1.100',
                permissions: { visible: true, level: 'readwrite' } },
              { id: 'node-2', name: 'NAS-备份节点', ip: '192.168.1.101',
                permissions: { visible: true, level: 'readonly' } },
              { id: 'node-3', name: 'NAS-测试节点', ip: '192.168.1.102',
                permissions: { visible: false, level: 'readonly' } }
            ],
            diskVisibility: [
              { id: 1, node: 'NAS-主节点', mount: '/mnt/disk1', size: 1000, visible: true },
              { id: 2, node: 'NAS-主节点', mount: '/mnt/disk2', size: 1000, visible: true },
              { id: 3, node: 'NAS-备份节点', mount: '/mnt/backup', size: 2000, visible: false }
            ]
          });
        },

        savePermissions(window) {
          alert('权限设置已保存!');
        },

        // ============ 纠删码配置 ============
        openECConfig() {
          this.createWindow({
            type: 'ec',
            title: '纠删码配置',
            icon: '🛡️',
            width: 1000,
            height: 700,
            ecConfig: {
              isConfigured: true,
              k: 8,
              m: 4,
              diskCount: 12,
              healthy: true
            },
            showConfigWizard: false,
            selectedScheme: null,
            ecSchemes: [
              { name: 'RS(4+2)', description: '4个数据块 + 2个校验块', k: 4, m: 2 },
              { name: 'RS(8+4)', description: '8个数据块 + 4个校验块', k: 8, m: 4 },
              { name: 'RS(12+4)', description: '12个数据块 + 4个校验块', k: 12, m: 4 }
            ],
            availableDisks: [
              { id: 1, node: 'NAS-主节点', mount: '/mnt/disk1', size: 1000, selected: false },
              { id: 2, node: 'NAS-主节点', mount: '/mnt/disk2', size: 1000, selected: false },
              { id: 3, node: 'NAS-备份节点', mount: '/mnt/disk1', size: 2000, selected: false }
            ]
          });
        },

        startECConfig(window) {
          window.showConfigWizard = true;
        },

        reconfigureEC(window) {
          window.showConfigWizard = true;
        },

        applyECConfig(window) {
          alert('纠删码配置已应用!');
          window.showConfigWizard = false;
          window.ecConfig.isConfigured = true;
        },

        // ============ 系统监控 ============
        openSystemMonitor() {
          this.createWindow({
            type: 'monitor',
            title: '系统监控',
            icon: '📊',
            width: 1200,
            height: 700,
            totalStorage: 12.5,
            usedStorage: 8.3,
            avgCpu: 45.2,
            networkTraffic: 156.8
          });
        }
      }
    }).mount('#app');
  </script>
</body>
</html>