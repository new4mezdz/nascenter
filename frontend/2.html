<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NAS Center ç®¡ç†ç³»ç»Ÿ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    /* æ–°å¢: å¼€å§‹èœå•æ ·å¼ */
.start-menu {
  position: fixed;
  bottom: 60px;
  left: 20px;
  width: 400px;
  background: rgba(30, 30, 30, 0.98);
  backdrop-filter: blur(20px);
  border-radius: 12px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  color: white;
  overflow: hidden;
  z-index: 1500;
  animation: slideUp 0.2s ease-out;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.start-menu-header {
  padding: 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.start-menu-section {
  padding: 12px;
}

.start-menu-section-title {
  padding: 8px 12px;
  font-size: 11px;
  font-weight: 600;
  color: rgba(255,255,255,0.6);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.start-menu-item {
  padding: 12px 16px;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 12px;
  transition: all 0.15s;
}

.start-menu-item:hover {
  background: rgba(255,255,255,0.1);
}

.start-menu-item-disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* æ–°å¢: é¡¶éƒ¨å¯¼èˆªæ æ ·å¼ */
.top-navbar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 45px;
  background: rgba(0,0,0,0.85);
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  padding: 0 20px;
  z-index: 999;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.navbar-button {
  padding: 6px 16px;
  background: rgba(255,255,255,0.1);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  color: white;
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 6px;
  border: 1px solid rgba(255,255,255,0.2);
}

.navbar-button:hover {
  background: rgba(255,255,255,0.2);
}

.navbar-divider {
  width: 1px;
  height: 24px;
  background: rgba(255,255,255,0.2);
  margin: 0 12px;
}

/* è°ƒæ•´æ¡Œé¢åŒºåŸŸä»¥é€‚åº”é¡¶éƒ¨å¯¼èˆªæ  */
.desktop-with-navbar {
  padding-top: 45px;
}
    .desktop {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      position: relative;
      user-select: none;
    }

    .desktop-icon {
      width: 90px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      padding: 8px;
    }

    .desktop-icon:hover {
      transform: translateY(-2px);
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
    }

    .window {
      position: absolute;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
      min-width: 400px;
      min-height: 300px;
      display: flex;
      flex-direction: column;
    }

    .window.maximized {
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: calc(100vh - 50px) !important;
      border-radius: 0;
    }

    .window-header {
      background: linear-gradient(180deg, #f7f7f7 0%, #e8e8e8 100%);
      padding: 12px 16px;
      cursor: move;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ddd;
    }

    .window-controls button {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: none;
      margin-left: 8px;
      cursor: pointer;
    }

    .window-controls .close { background: #ff5f57; }
    .window-controls .minimize { background: #ffbd2e; }
    .window-controls .maximize { background: #28ca42; }

    .window-content {
      flex: 1;
      overflow: auto;
    }

    .taskbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 50px;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      padding: 0 20px;
      z-index: 1000;
    }

    .taskbar-item {
      height: 40px;
      padding: 0 16px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      margin-right: 8px;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s;
      color: white;
    }

    .taskbar-item:hover {
      background: rgba(255,255,255,0.2);
    }

    .taskbar-item.active {
      background: rgba(255,255,255,0.3);
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    /* æ¨¡æ€å¯¹è¯æ¡† */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
}

.modal-content {
    background: white;
    border-radius: 12px;
    padding: 24px;
    max-width: 600px;
    width: 90%;
}

/* å¾½ç«  */
.badge {
    display: inline-block;
    padding: 4px 8px;
    background: #e5e7eb;
    border-radius: 4px;
    font-size: 12px;
    margin: 2px;
}

/* å¡ç‰‡ */
.card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.card:hover {
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

/* æ ‡ç­¾é¡µæ¿€æ´»æ ·å¼ */
.tab-active {
    background: white;
    border-bottom: 2px solid #3b82f6;
    color: #3b82f6;
}

    .window {
      animation: fadeIn 0.2s ease-out;
    }

    .icon-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, 90px);
      gap: 20px;
      padding: 20px;
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  </style>
</head>
<body>

  <div id="app">
    <div class="top-navbar" v-if="showNavbar">
    <div class="flex items-center gap-2">
      <button @click="returnToMainCenter" class="navbar-button">
        <span>ğŸ </span>
        <span>è¿”å›ä¸»æ§ä¸­å¿ƒ</span>
      </button>

      <div class="navbar-divider"></div>

      <span class="text-white text-sm flex items-center gap-2">
        <span class="text-green-400">â—</span>
        å½“å‰èŠ‚ç‚¹: <strong>{{ currentNodeName }}</strong>
      </span>
    </div>

    <div class="ml-auto flex items-center gap-3">
  <button @click="openNodeManagement" class="navbar-button">
    <span>ğŸ”„</span>
    <span>åˆ‡æ¢èŠ‚ç‚¹</span>
  </button>

  <button @click="refreshCurrentNode" class="navbar-button">
    <span>ğŸ”ƒ</span>
    <span>åˆ·æ–°</span>
  </button>

  <!-- âœ… æ–°å¢:ç”¨æˆ·ä¿¡æ¯ -->
  <div class="text-white text-sm flex items-center gap-2">
    <span>ğŸ‘¤</span>
    <span>{{ currentUser }}</span>
  </div>

  <!-- âœ… æ–°å¢:é€€å‡ºç™»å½•æŒ‰é’® -->
  <button @click="logout" class="navbar-button bg-red-500 hover:bg-red-600">
    <span>ğŸšª</span>
    <span>é€€å‡º</span>
  </button>
</div>
  </div>

    <div :class="['desktop fixed inset-0', { 'desktop-with-navbar': showNavbar }]" @click="closeAllMenus">

      <div class="icon-grid p-8">
        <!-- èŠ‚ç‚¹ç®¡ç† -->
        <div class="desktop-icon" @dblclick="openNodeManagement">
          <div class="w-16 h-16 mx-auto mb-2 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-4xl">
            ğŸ–¥ï¸
          </div>
          <div class="text-white text-xs font-semibold drop-shadow-lg">èŠ‚ç‚¹ç®¡ç†</div>
        </div>

        <!-- ç©ºé—´åˆ†é… -->
        <div class="desktop-icon" @dblclick="openSpaceAllocation">
          <div class="w-16 h-16 mx-auto mb-2 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-4xl">
            ğŸ“¦
          </div>
          <div class="text-white text-xs font-semibold drop-shadow-lg">ç©ºé—´åˆ†é…</div>
        </div>

        <!-- æƒé™è®¾ç½® -->
        <div class="desktop-icon" @dblclick="openPermissionSettings">
          <div class="w-16 h-16 mx-auto mb-2 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-4xl">
            ğŸ”’
          </div>
          <div class="text-white text-xs font-semibold drop-shadow-lg">æƒé™è®¾ç½®</div>
        </div>

        <!-- åŠ å¯†ç®¡ç† -->
        <div class="desktop-icon" @dblclick="openEncryptionManager">
          <div class="w-16 h-16 mx-auto mb-2 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-4xl">
            ğŸ”
          </div>
          <div class="text-white text-xs font-semibold drop-shadow-lg">åŠ å¯†ç®¡ç†</div>
        </div>

        <!-- çº åˆ ç é…ç½® -->
        <div class="desktop-icon" @dblclick="openECConfig">
          <div class="w-16 h-16 mx-auto mb-2 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-4xl">
            ğŸ›¡ï¸
          </div>
          <div class="text-white text-xs font-semibold drop-shadow-lg">çº åˆ ç é…ç½®</div>
        </div>

        <!-- ç³»ç»Ÿç›‘æ§ -->
        <div class="desktop-icon" @dblclick="openSystemMonitor">
          <div class="w-16 h-16 mx-auto mb-2 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-4xl">
            ğŸ“Š
          </div>
          <div class="text-white text-xs font-semibold drop-shadow-lg">ç³»ç»Ÿç›‘æ§</div>
        </div>
      </div>

      <div v-for="window in windows" :key="window.id"
           :class="['window', { maximized: window.maximized }]"
           :style="window.maximized ? {} : {
             top: window.y + 'px',
             left: window.x + 'px',
             width: window.width + 'px',
             height: window.height + 'px',
             zIndex: window.zIndex,
             display: window.minimized ? 'none' : 'flex'
           }"
           @mousedown="focusWindow(window.id)">

        <div class="window-header" @mousedown="startDrag($event, window)">
          <div class="flex items-center gap-2">
            <span class="text-2xl">{{ window.icon }}</span>
            <span class="font-semibold text-sm">{{ window.title }}</span>
          </div>
          <div class="window-controls flex">
            <button class="minimize" @click.stop="minimizeWindow(window.id)"></button>
            <button class="maximize" @click.stop="toggleMaximize(window.id)"></button>
            <button class="close" @click.stop="closeWindow(window.id)"></button>
          </div>
        </div>

        <div class="window-content" style="padding: 0; overflow: hidden;">

          <!-- èŠ‚ç‚¹ç®¡ç†çª—å£ -->
          <div v-if="window.type === 'nodes'" class="h-full flex flex-col">
            <div class="px-6 py-4 border-b bg-gradient-to-r from-blue-50 to-purple-50">
              <div class="flex justify-between items-center">
                <div>
                  <h3 class="text-xl font-bold flex items-center gap-2">
                    <span class="text-3xl">ğŸ–¥ï¸</span>
                    èŠ‚ç‚¹ç®¡ç†
                  </h3>
                  <p class="text-sm text-gray-600 mt-1">ç®¡ç†å’Œç›‘æ§æ‰€æœ‰ NAS èŠ‚ç‚¹</p>
                </div>
                <button @click="refreshNodes(window)"
                        class="px-4 py-2 bg-white border rounded-lg hover:bg-gray-50 transition flex items-center gap-2">
                  <span v-if="window.loading" class="loading"></span>
                  <span v-else>ğŸ”„</span>
                  åˆ·æ–°
                </button>
              </div>
            </div>

            <div v-if="window.stats" class="grid grid-cols-4 gap-4 p-6 bg-gray-50">
              <div class="bg-white rounded-lg shadow p-4 border">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-xs text-gray-600 mb-1">æ€»èŠ‚ç‚¹</div>
                    <div class="text-2xl font-bold text-blue-600">{{ window.stats.total }}</div>
                  </div>
                  <div class="text-4xl">ğŸ–¥ï¸</div>
                </div>
              </div>
              <div class="bg-white rounded-lg shadow p-4 border">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-xs text-gray-600 mb-1">åœ¨çº¿</div>
                    <div class="text-2xl font-bold text-green-600">{{ window.stats.online }}</div>
                  </div>
                  <div class="text-4xl">âœ…</div>
                </div>
              </div>
              <div class="bg-white rounded-lg shadow p-4 border">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-xs text-gray-600 mb-1">ç¦»çº¿</div>
                    <div class="text-2xl font-bold text-red-600">{{ window.stats.offline }}</div>
                  </div>
                  <div class="text-4xl">âŒ</div>
                </div>
              </div>
              <div class="bg-white rounded-lg shadow p-4 border">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-xs text-gray-600 mb-1">è­¦å‘Š</div>
                    <div class="text-2xl font-bold text-yellow-600">{{ window.stats.warning }}</div>
                  </div>
                  <div class="text-4xl">âš ï¸</div>
                </div>
              </div>
            </div>

            <div class="flex-1 overflow-auto p-6 bg-gray-50">
              <div class="bg-white rounded-lg shadow border">
                <table class="w-full">
                  <thead class="bg-gray-50 border-b">
                    <tr>
                      <th class="text-left p-4 font-semibold text-gray-700">èŠ‚ç‚¹åç§°</th>
                      <th class="text-left p-4 font-semibold text-gray-700">åœ°å€</th>
                      <th class="text-left p-4 font-semibold text-gray-700">çŠ¶æ€</th>
                      <th class="text-left p-4 font-semibold text-gray-700">CPU</th>
                      <th class="text-left p-4 font-semibold text-gray-700">å†…å­˜</th>
                      <th class="text-left p-4 font-semibold text-gray-700">ç£ç›˜</th>
                      <th class="text-left p-4 font-semibold text-gray-700">æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="node in window.nodes" :key="node.id"
                        class="border-b hover:bg-gray-50">
                      <td class="p-4">
                        <div class="font-semibold text-gray-800">{{ node.name }}</div>
                        <div class="text-xs text-gray-500">{{ node.id }}</div>
                      </td>
                      <td class="p-4 text-sm">{{ node.ip }}:{{ node.port }}</td>
                      <td class="p-4">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold"
                              :class="getStatusClass(node.status)">
                          {{ getStatusText(node.status) }}
                        </span>
                      </td>
                      <td class="p-4">
                        <span v-if="node.status !== 'offline'" class="text-sm font-semibold"
                              :class="node.cpu_usage > 80 ? 'text-red-600' : 'text-gray-700'">
                          {{ node.cpu_usage.toFixed(1) }}%
                        </span>
                        <span v-else class="text-sm text-gray-400">-</span>
                      </td>
                      <td class="p-4">
                        <span v-if="node.status !== 'offline'" class="text-sm font-semibold"
                              :class="node.memory_usage > 80 ? 'text-red-600' : 'text-gray-700'">
                          {{ node.memory_usage.toFixed(1) }}%
                        </span>
                        <span v-else class="text-sm text-gray-400">-</span>
                      </td>
                      <td class="p-4">
                        <span v-if="node.status !== 'offline'" class="text-sm font-semibold"
                              :class="node.disk_usage > 80 ? 'text-red-600' : 'text-gray-700'">
                          {{ node.disk_usage.toFixed(1) }}%
                        </span>
                        <span v-else class="text-sm text-gray-400">-</span>
                      </td>
                      <td class="p-4">
                        <div class="flex gap-2">
                          <button @click="viewNodeDisks(window, node)"
                                  :disabled="node.status === 'offline'"
                                  :class="node.status === 'offline' ? 'opacity-50 cursor-not-allowed bg-gray-400' : 'bg-blue-500 hover:bg-blue-600'"
                                  class="px-3 py-1 text-white rounded text-xs">
                            ğŸ’¾ ç£ç›˜
                          </button>
                          <button @click="accessNode(node)"
                                  :disabled="node.status === 'offline'"
                                  :class="node.status === 'offline' ? 'opacity-50 cursor-not-allowed bg-gray-400' : 'bg-green-500 hover:bg-green-600'"
                                  class="px-3 py-1 text-white rounded text-xs">
                            ğŸ”— è®¿é—®
                          </button>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- ç£ç›˜ä¿¡æ¯å¼¹çª— -->
            <div v-if="window.selectedNodeDisks"
                 @click="window.selectedNodeDisks = null"
                 class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div @click.stop class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-[80vh] overflow-hidden">
                <div class="px-6 py-4 border-b bg-gradient-to-r from-blue-500 to-purple-600 text-white">
                  <h3 class="text-xl font-bold">{{ window.selectedNodeDisks.name }} - ç£ç›˜ä¿¡æ¯</h3>
                </div>
                <div class="p-6 overflow-y-auto max-h-[60vh]">
                  <div v-if="window.selectedNodeDisks.loading" class="flex items-center justify-center py-12">
                    <div class="loading"></div>
                    <span class="ml-3 text-gray-600">æ­£åœ¨åŠ è½½ç£ç›˜ä¿¡æ¯...</span>
                  </div>
                  <div v-else-if="window.selectedNodeDisks.error" class="text-center py-12">
                    <div class="text-red-500 text-lg mb-2">âŒ åŠ è½½å¤±è´¥</div>
                    <div class="text-gray-600">{{ window.selectedNodeDisks.error }}</div>
                  </div>
                  <div v-else class="space-y-4">
                    <div v-for="(disk, index) in window.selectedNodeDisks.disks" :key="index"
                         class="border rounded-lg p-4 bg-gray-50">
                      <div class="flex justify-between items-start mb-3">
                        <div>
                          <div class="font-bold text-lg">{{ disk.mount }}</div>
                          <div class="text-sm text-gray-600">æ€»å®¹é‡: {{ disk.total_gb }} GB</div>
                        </div>
                        <span v-if="disk.ec_scheme" class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">
                          ğŸ›¡ï¸ {{ disk.ec_scheme }}
                        </span>
                      </div>
                      <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="h-4 rounded-full flex items-center justify-center text-xs text-white font-semibold"
                             :class="disk.usage_percent > 90 ? 'bg-red-500' : disk.usage_percent > 70 ? 'bg-yellow-500' : 'bg-green-500'"
                             :style="{ width: disk.usage_percent + '%' }">
                          {{ disk.usage_percent.toFixed(1) }}%
                        </div>
                      </div>
                      <div class="flex justify-between text-xs text-gray-600 mt-2">
                        <span>å·²ç”¨: {{ disk.used_gb }} GB</span>
                        <span>å¯ç”¨: {{ disk.free_gb }} GB</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="px-6 py-4 border-t bg-gray-50 flex justify-end">
                  <button @click="window.selectedNodeDisks = null"
                          class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                    å…³é—­
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- ç©ºé—´åˆ†é…çª—å£ -->
          <div v-if="window.type === 'space-allocation'" class="h-full flex flex-col">
            <div class="px-6 py-4 border-b bg-gradient-to-r from-purple-50 to-pink-50">
              <h3 class="text-xl font-bold flex items-center gap-2">
                <span class="text-3xl">ğŸ“¦</span>
                è·¨èŠ‚ç‚¹ç©ºé—´åˆ†é…
              </h3>
              <p class="text-sm text-gray-600 mt-1">å°†å¤§æ–‡ä»¶åˆ†å‘åˆ°å¤šä¸ªèŠ‚ç‚¹å­˜å‚¨,ä¼˜åŒ–ç©ºé—´åˆ©ç”¨</p>
            </div>

            <div class="flex-1 overflow-auto p-6 bg-gray-50">
              <!-- åˆ†é…ç­–ç•¥é€‰æ‹© -->
              <div class="bg-white rounded-lg shadow border p-6 mb-6">
                <h4 class="font-bold text-lg mb-4">åˆ†é…ç­–ç•¥</h4>
                <div class="grid grid-cols-3 gap-4">
                  <div class="border-2 border-blue-500 rounded-lg p-4 cursor-pointer hover:bg-blue-50">
                    <div class="text-3xl mb-2">âš–ï¸</div>
                    <div class="font-semibold">è´Ÿè½½å‡è¡¡</div>
                    <div class="text-xs text-gray-600 mt-1">å¹³å‡åˆ†é…åˆ°æ‰€æœ‰èŠ‚ç‚¹</div>
                  </div>
                  <div class="border-2 border-gray-300 rounded-lg p-4 cursor-pointer hover:bg-gray-50">
                    <div class="text-3xl mb-2">ğŸ’¾</div>
                    <div class="font-semibold">ç©ºé—´ä¼˜å…ˆ</div>
                    <div class="text-xs text-gray-600 mt-1">ä¼˜å…ˆä½¿ç”¨ç©ºé—´è¾ƒå¤§çš„èŠ‚ç‚¹</div>
                  </div>
                  <div class="border-2 border-gray-300 rounded-lg p-4 cursor-pointer hover:bg-gray-50">
                    <div class="text-3xl mb-2">âš¡</div>
                    <div class="font-semibold">æ€§èƒ½ä¼˜å…ˆ</div>
                    <div class="text-xs text-gray-600 mt-1">ä¼˜å…ˆä½¿ç”¨é«˜æ€§èƒ½èŠ‚ç‚¹</div>
                  </div>
                </div>
              </div>

              <!-- æºæ–‡ä»¶é€‰æ‹© -->
              <div class="bg-white rounded-lg shadow border p-6 mb-6">
                <h4 class="font-bold text-lg mb-4">é€‰æ‹©è¦åˆ†é…çš„æ–‡ä»¶</h4>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                  <div class="text-6xl mb-4">ğŸ“</div>
                  <p class="text-gray-600 mb-4">é€‰æ‹©æºèŠ‚ç‚¹å’Œæ–‡ä»¶</p>
                  <button class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                    æµè§ˆæ–‡ä»¶
                  </button>
                </div>

                <!-- å·²é€‰æ–‡ä»¶åˆ—è¡¨ç¤ºä¾‹ -->
                <div class="mt-4 space-y-2">
                  <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-3">
                      <span class="text-2xl">ğŸ¬</span>
                      <div>
                        <div class="font-semibold">movie_4K.mp4</div>
                        <div class="text-xs text-gray-500">25.6 GB - æ¥è‡ªèŠ‚ç‚¹: NAS-ä¸»èŠ‚ç‚¹</div>
                      </div>
                    </div>
                    <button class="text-red-500 hover:text-red-700">âœ•</button>
                  </div>
                </div>
              </div>

              <!-- ç›®æ ‡èŠ‚ç‚¹é€‰æ‹© -->
              <div class="bg-white rounded-lg shadow border p-6 mb-6">
                <h4 class="font-bold text-lg mb-4">é€‰æ‹©ç›®æ ‡èŠ‚ç‚¹ (è‡³å°‘2ä¸ª)</h4>
                <div class="space-y-2">
                  <div class="flex items-center p-3 border-2 border-blue-500 bg-blue-50 rounded-lg">
                    <input type="checkbox" checked class="mr-3 h-5 w-5">
                    <div class="flex-1">
                      <div class="font-semibold">NAS-å¤‡ä»½èŠ‚ç‚¹</div>
                      <div class="text-xs text-gray-600">å¯ç”¨ç©ºé—´: 1.2 TB | CPU: 25% | å»¶è¿Ÿ: 12ms</div>
                    </div>
                    <div class="text-green-600 font-semibold">âœ“ å·²é€‰</div>
                  </div>

                  <div class="flex items-center p-3 border-2 border-blue-500 bg-blue-50 rounded-lg">
                    <input type="checkbox" checked class="mr-3 h-5 w-5">
                    <div class="flex-1">
                      <div class="font-semibold">æˆ‘çš„æœ¬åœ°èŠ‚ç‚¹</div>
                      <div class="text-xs text-gray-600">å¯ç”¨ç©ºé—´: 800 GB | CPU: 15% | å»¶è¿Ÿ: 2ms</div>
                    </div>
                    <div class="text-green-600 font-semibold">âœ“ å·²é€‰</div>
                  </div>

                  <div class="flex items-center p-3 border-2 border-gray-300 rounded-lg">
                    <input type="checkbox" class="mr-3 h-5 w-5">
                    <div class="flex-1">
                      <div class="font-semibold">NAS-å­˜æ¡£èŠ‚ç‚¹</div>
                      <div class="text-xs text-gray-600">å¯ç”¨ç©ºé—´: 3.5 TB | CPU: 40% | å»¶è¿Ÿ: 28ms</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- åˆ†é…é¢„è§ˆ -->
              <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-l-4 border-blue-500 p-4 rounded">
                <h4 class="font-semibold text-blue-900 mb-2">ğŸ“Š åˆ†é…é¢„è§ˆ</h4>
                <div class="text-sm text-blue-800 space-y-1">
                  <p>â€¢ æ–‡ä»¶æ•°é‡: <strong>1</strong> ä¸ª</p>
                  <p>â€¢ æ€»å¤§å°: <strong>25.6 GB</strong></p>
                  <p>â€¢ ç›®æ ‡èŠ‚ç‚¹: <strong>2</strong> ä¸ª</p>
                  <p>â€¢ æ¯èŠ‚ç‚¹åˆ†é…: <strong>çº¦ 12.8 GB</strong></p>
                  <p>â€¢ é¢„è®¡è€—æ—¶: <strong>çº¦ 8-12 åˆ†é’Ÿ</strong></p>
                </div>
              </div>

              <!-- æ‰§è¡ŒæŒ‰é’® -->
              <div class="mt-6 flex justify-end gap-3">
                <button class="px-6 py-3 bg-gray-200 rounded-lg hover:bg-gray-300">
                  å–æ¶ˆ
                </button>
                <button class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2">
                  <span>ğŸš€</span>
                  å¼€å§‹åˆ†é…
                </button>
              </div>
            </div>
          </div>

          <!-- æƒé™è®¾ç½®çª—å£ -->
          <div v-if="window.type === 'permissions'" class="h-full flex flex-col">

    <!-- ========== 1. æ ‡ç­¾é¡µå¯¼èˆª ========== -->
    <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
<div class="flex border-b bg-gray-50">
    <button @click="window.permissionTab = 'users'"
            :class="window.permissionTab === 'users' ? 'bg-white border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
            class="px-6 py-3 font-semibold transition">
        ğŸ‘¤ ç”¨æˆ·ç®¡ç†
    </button>
    <button @click="window.permissionTab = 'node-groups'"
            :class="window.permissionTab === 'node-groups' ? 'bg-white border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
            class="px-6 py-3 font-semibold transition">
        ğŸ“ èŠ‚ç‚¹åˆ†ç»„
    </button>
    <button @click="window.permissionTab = 'node-access'"
            :class="window.permissionTab === 'node-access' ? 'bg-white border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
            class="px-6 py-3 font-semibold transition">
        ğŸ” èŠ‚ç‚¹è®¿é—®æ§åˆ¶
    </button>
    <button @click="window.permissionTab = 'audit'"
            :class="window.permissionTab === 'audit' ? 'bg-white border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
            class="px-6 py-3 font-semibold transition">
        ğŸ“‹ å®¡è®¡æ—¥å¿—
    </button>
</div>

    <!-- ========== 2. ç”¨æˆ·ç®¡ç†æ ‡ç­¾é¡µ ========== -->
    <div v-if="window.permissionTab === 'users'" class="flex-1 overflow-auto p-6">
        <!-- é¡¶éƒ¨æŒ‰é’® -->
        <button @click="window.showUserDialog = true">
            â• æ·»åŠ ç”¨æˆ·
        </button>


        <!-- ç”¨æˆ·åˆ—è¡¨è¡¨æ ¼ -->
<div class="bg-white rounded-lg shadow border mt-4">
    <table class="w-full">
        <thead class="bg-gray-50 border-b">
            <tr>
                <th class="text-left p-4 font-semibold text-gray-700">ç”¨æˆ·å</th>
                <th class="text-left p-4 font-semibold text-gray-700">è§’è‰²</th>
                <th class="text-left p-4 font-semibold text-gray-700">é‚®ç®±</th>
                <th class="text-left p-4 font-semibold text-gray-700">çŠ¶æ€</th>
                <th class="text-left p-4 font-semibold text-gray-700">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            <tr v-for="user in window.users" :key="user.id" class="border-b hover:bg-gray-50">
                <td class="p-4">
                    <div class="font-semibold text-gray-800">{{ user.username }}</div>
                </td>
                <td class="p-4">
                    <span class="px-3 py-1 rounded-full text-xs font-semibold"
                          :class="user.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'">
                        {{ user.role === 'admin' ? 'ç®¡ç†å‘˜' : user.role === 'user' ? 'æ™®é€šç”¨æˆ·' : 'è®¿å®¢' }}
                    </span>
                </td>
                <td class="p-4 text-sm text-gray-600">{{ user.email || '-' }}</td>
                <td class="p-4">
                    <span class="px-3 py-1 rounded-full text-xs font-semibold"
                          :class="user.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'">
                        {{ user.status === 'active' ? 'æ­£å¸¸' : 'å·²ç¦ç”¨' }}
                    </span>
                </td>
                <td class="p-4">
                    <div class="flex gap-2">
                        <button @click="editUser(window, user)"
                                class="px-3 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">
                            ç¼–è¾‘
                        </button>
                        <button @click="deleteUser(window, user.id)"
                                class="px-3 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">
                            åˆ é™¤
                        </button>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>

        <!-- ç”¨æˆ·å¯¹è¯æ¡† -->
<div v-if="window.showUserDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4">
        <div class="px-6 py-4 border-b bg-gradient-to-r from-blue-500 to-purple-600 text-white">
            <h3 class="text-xl font-bold">{{ window.editingUser ? 'ç¼–è¾‘ç”¨æˆ·' : 'æ·»åŠ ç”¨æˆ·' }}</h3>
        </div>

        <form @submit.prevent="createUser(window)" class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ·å</label>
                <input v-model="window.userForm.username"
                       placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
                       required
                       class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">é‚®ç®±</label>
                <input v-model="window.userForm.email"
                       type="email"
                       placeholder="è¯·è¾“å…¥é‚®ç®±"
                       class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">å¯†ç </label>
                <input v-model="window.userForm.password"
                       type="password"
                       placeholder="è¯·è¾“å…¥å¯†ç "
                       required
                       class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">è§’è‰²</label>
                <select v-model="window.userForm.role"
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    <option value="admin">ç®¡ç†å‘˜</option>
                    <option value="user">æ™®é€šç”¨æˆ·</option>
                    <option value="guest">è®¿å®¢</option>
                </select>
            </div>

            <div class="flex gap-3 pt-4">
                <button type="submit"
                        class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-semibold">
                    ä¿å­˜
                </button>
                <button type="button"
                        @click="window.showUserDialog = false"
                        class="flex-1 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 font-semibold">
                    å–æ¶ˆ
                </button>
            </div>
        </form>
    </div>
</div>
    </div>

    <!-- ========== 3. èŠ‚ç‚¹åˆ†ç»„æ ‡ç­¾é¡µ ========== -->
    <div v-if="window.permissionTab === 'node-groups'" class="flex-1 overflow-auto p-6">
        <!-- é¡¶éƒ¨æŒ‰é’® -->
        <button @click="window.showGroupDialog = true">
            â• æ–°å»ºåˆ†ç»„
        </button>

        <!-- åˆ†ç»„å¡ç‰‡ç½‘æ ¼ -->
        <div class="grid grid-cols-3 gap-4">
            <div v-for="group in window.nodeGroups" class="card">
                <!-- åˆ†ç»„å›¾æ ‡+åç§° -->
                <div class="flex items-center gap-2">
                    <span class="text-3xl">{{ group.icon }}</span>
                    <div>
                        <div class="font-bold">{{ group.group_name }}</div>
                        <div class="text-xs">{{ group.description }}</div>
                    </div>
                    <div class="color-badge" :style="{backgroundColor: group.color}"></div>
                </div>

                <!-- åŒ…å«çš„èŠ‚ç‚¹åˆ—è¡¨ -->
                <div>
                    <div class="text-xs mb-1">åŒ…å«èŠ‚ç‚¹:</div>
                    <span v-for="nodeId in group.node_ids" class="badge">
                        {{ getNodeName(window, nodeId) }}
                    </span>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <button @click="editNodeGroup(window, group)">ç¼–è¾‘</button>
                <button @click="deleteNodeGroup(window, group.group_id)">åˆ é™¤</button>
            </div>
        </div>


        <!-- åˆ†ç»„å¯¹è¯æ¡† -->
<div v-if="window.showGroupDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="px-6 py-4 border-b bg-gradient-to-r from-green-500 to-teal-600 text-white">
            <h3 class="text-xl font-bold">{{ window.editingGroup ? 'ç¼–è¾‘åˆ†ç»„' : 'æ–°å»ºåˆ†ç»„' }}</h3>
        </div>

        <form @submit.prevent="createNodeGroup(window)" class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†ç»„åç§°</label>
                <input v-model="window.groupForm.group_name"
                       placeholder="è¯·è¾“å…¥åˆ†ç»„åç§°"
                       required
                       class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 outline-none">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">æè¿°</label>
                <textarea v-model="window.groupForm.description"
                          placeholder="è¯·è¾“å…¥æè¿°"
                          rows="2"
                          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 outline-none"></textarea>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©èŠ‚ç‚¹</label>
                <div class="border rounded-lg p-3 space-y-2 max-h-48 overflow-y-auto">
                    <label v-for="node in window.nodes" :key="node.id"
                           class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="checkbox"
                               :value="node.id"
                               v-model="window.groupForm.node_ids"
                               class="h-4 w-4">
                        <span>{{ node.name }}</span>
                    </label>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å›¾æ ‡</label>
                    <select v-model="window.groupForm.icon"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 outline-none">
                        <option value="ğŸ”¥">ğŸ”¥ æ ¸å¿ƒ</option>
                        <option value="ğŸ’¾">ğŸ’¾ å¤‡ä»½</option>
                        <option value="ğŸ ">ğŸ  æœ¬åœ°</option>
                        <option value="ğŸ“¦">ğŸ“¦ å­˜æ¡£</option>
                        <option value="â˜ï¸">â˜ï¸ äº‘ç«¯</option>
                        <option value="âš¡">âš¡ é«˜æ€§èƒ½</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">é¢œè‰²</label>
                    <input type="color"
                           v-model="window.groupForm.color"
                           class="w-full h-10 px-2 border rounded-lg cursor-pointer">
                </div>
            </div>

            <div class="flex gap-3 pt-4">
                <button type="submit"
                        class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold">
                    ä¿å­˜
                </button>
                <button type="button"
                        @click="window.showGroupDialog = false"
                        class="flex-1 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 font-semibold">
                    å–æ¶ˆ
                </button>
            </div>
        </form>
    </div>
</div>
    </div>

    <!-- ========== 4. èŠ‚ç‚¹è®¿é—®æ§åˆ¶æ ‡ç­¾é¡µ ========== -->
    <div v-if="window.permissionTab === 'node-access'" class="flex-1 overflow-auto p-6">
        <!-- ç”¨æˆ·é€‰æ‹© -->
        <select @change="loadUserNodeAccess(window, $event.target.value)">
            <option value="">é€‰æ‹©ç”¨æˆ·...</option>
            <option v-for="user in window.users" :value="user.id">
                {{ user.username }}
            </option>
        </select>

        <!-- æƒé™é…ç½®è¡¨å• (v-if="window.selectedUserId") -->
        <div class="permission-form">
            <h4>è®¿é—®æƒé™ç±»å‹</h4>
            <select v-model="window.accessForm.type">
                <option value="all">æ‰€æœ‰èŠ‚ç‚¹</option>
                <option value="none">æ— è®¿é—®æƒé™</option>
                <option value="group_based">åŸºäºåˆ†ç»„</option>
                <option value="custom">è‡ªå®šä¹‰</option>
            </select>

            <!-- å¦‚æœé€‰æ‹©äº† group_based -->
            <div v-if="window.accessForm.type === 'group_based'">
                <h5>é€‰æ‹©å…è®¸è®¿é—®çš„åˆ†ç»„:</h5>
                <label v-for="group in window.nodeGroups">
                    <input type="checkbox"
                           :value="group.group_id"
                           v-model="window.accessForm.allowed_groups">
                    <span>{{ group.icon }} {{ group.group_name }}</span>
                    <span class="text-xs">({{ group.node_ids.length }}ä¸ªèŠ‚ç‚¹)</span>
                </label>
            </div>

            <!-- é¢å¤–å•ç‹¬æˆæƒçš„èŠ‚ç‚¹ -->
            <div>
                <h5>é¢å¤–æˆæƒèŠ‚ç‚¹:</h5>
                <label v-for="node in window.nodes">
                    <input type="checkbox"
                           :value="node.id"
                           v-model="window.accessForm.allowed_nodes">
                    {{ node.name }}
                </label>
            </div>

            <!-- æ˜ç¡®æ‹’ç»çš„èŠ‚ç‚¹ -->
            <div>
                <h5>æ‹’ç»è®¿é—®çš„èŠ‚ç‚¹(ä¼˜å…ˆçº§æœ€é«˜):</h5>
                <label v-for="node in window.nodes">
                    <input type="checkbox"
                           :value="node.id"
                           v-model="window.accessForm.denied_nodes">
                    {{ node.name }}
                </label>
            </div>

            <button @click="saveUserNodeAccess(window)">ğŸ’¾ ä¿å­˜æƒé™</button>
        </div>
    </div>

    <!-- ========== 5. å®¡è®¡æ—¥å¿—æ ‡ç­¾é¡µ ========== -->
    <div v-if="window.permissionTab === 'audit'" class="flex-1 overflow-auto p-6">
        <!-- ç­›é€‰æ¡ä»¶ -->
        <div class="filters">
            <input placeholder="ç”¨æˆ·å">
            <select>
                <option value="">æ‰€æœ‰æ“ä½œ</option>
                <option value="login">ç™»å½•</option>
                <option value="access_node">è®¿é—®èŠ‚ç‚¹</option>
                <option value="delete_file">åˆ é™¤æ–‡ä»¶</option>
            </select>
            <input type="date" placeholder="å¼€å§‹æ—¥æœŸ">
            <input type="date" placeholder="ç»“æŸæ—¥æœŸ">
            <button @click="loadAuditLogs(window, {...})">ğŸ” æŸ¥è¯¢</button>
        </div>

        <!-- æ—¥å¿—åˆ—è¡¨ -->
        <table>
            <thead>
                <tr>
                    <th>æ—¶é—´</th>
                    <th>ç”¨æˆ·</th>
                    <th>æ“ä½œ</th>
                    <th>ç›®æ ‡</th>
                    <th>èŠ‚ç‚¹</th>
                    <th>IPåœ°å€</th>
                    <th>çŠ¶æ€</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="log in window.auditLogs">
                    <td>{{ log.timestamp }}</td>
                    <td>{{ log.username }}</td>
                    <td>{{ log.action }}</td>
                    <td>{{ log.target }}</td>
                    <td>{{ log.node_id }}</td>
                    <td>{{ log.ip_address }}</td>
                    <td :class="log.status === 'success' ? 'text-green-600' : 'text-red-600'">
                        {{ log.status }}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

</div>


          <!-- åŠ å¯†ç®¡ç†çª—å£ -->
          <div v-if="window.type === 'encryption'" class="h-full flex flex-col">
            <div class="px-6 py-4 border-b bg-gradient-to-r from-indigo-50 to-purple-50">
              <h3 class="text-xl font-bold flex items-center gap-2">
                <span class="text-3xl">ğŸ”</span>
                åŠ å¯†ç®¡ç†ä¸­å¿ƒ
              </h3>
              <p class="text-sm text-gray-600 mt-1">ç®¡ç†ç£ç›˜åŠ å¯†å’Œæ–‡ä»¶åŠ å¯†</p>
            </div>

            <!-- æ ‡ç­¾é¡µ -->
            <div class="flex border-b bg-gray-50">
              <button @click="window.encryptionTab = 'disk'"
                      :class="window.encryptionTab === 'disk' ? 'bg-white border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
                      class="px-6 py-3 font-semibold transition">
                ğŸ’¾ ç£ç›˜åŠ å¯†
              </button>
              <button @click="window.encryptionTab = 'file'"
                      :class="window.encryptionTab === 'file' ? 'bg-white border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
                      class="px-6 py-3 font-semibold transition">
                ğŸ“„ æ–‡ä»¶åŠ å¯†
              </button>
            </div>

            <div class="flex-1 overflow-auto p-6 bg-gray-50">
              <!-- ç£ç›˜åŠ å¯†æ ‡ç­¾é¡µ -->
              <div v-if="window.encryptionTab === 'disk'" class="space-y-4">
                <div class="bg-purple-50 border-l-4 border-purple-500 p-4 rounded">
                  <div class="flex items-start gap-3">
                    <span class="text-2xl">ğŸ’¡</span>
                    <div>
                      <h4 class="font-semibold text-purple-900 mb-1">å…¨ç›˜åŠ å¯†è¯´æ˜</h4>
                      <p class="text-sm text-purple-800">
                        ä¸ºç‰©ç†ç¡¬ç›˜è®¾ç½®å¯†ç ,ä¿æŠ¤æ•°æ®å®‰å…¨ã€‚åŠ å¯†åçš„ç¡¬ç›˜åœ¨è§£é”å‰æ— æ³•è®¿é—®ã€‚
                        æœåŠ¡å™¨é‡å¯åæ‰€æœ‰ç¡¬ç›˜å°†è‡ªåŠ¨é”å®š,éœ€è¦è¾“å…¥å¯†ç æ‰èƒ½è®¿é—®ã€‚
                      </p>
                    </div>
                  </div>
                </div>

                <!-- ç£ç›˜åŠ å¯†çŠ¶æ€åˆ—è¡¨ -->
                <div class="bg-white rounded-lg shadow border">
                  <div class="p-4 border-b font-semibold text-gray-700">ç£ç›˜åŠ å¯†çŠ¶æ€</div>
                  <div class="space-y-3 p-4">
                    <!-- ç¤ºä¾‹ç£ç›˜1 - å·²åŠ å¯†å·²è§£é” -->
                    <div class="flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50">
                      <div class="flex items-center gap-4">
                        <span class="text-4xl">ğŸ”“</span>
                        <div>
                          <div class="font-bold font-mono text-lg">D:\</div>
                          <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs font-semibold bg-green-100 text-green-700 px-2 py-0.5 rounded-full">
                              âœ“ å·²è§£é”
                            </span>
                            <span class="text-xs text-gray-500">å®¹é‡: 2 TB</span>
                          </div>
                        </div>
                      </div>
                      <div class="flex gap-2">
                        <button class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
                          ğŸ”’ é”å®š
                        </button>
                        <button class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">
                          ğŸ”‘ æ”¹å¯†ç 
                        </button>
                        <button class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                          ğŸ—‘ï¸ ç§»é™¤åŠ å¯†
                        </button>
                      </div>
                    </div>

                    <!-- ç¤ºä¾‹ç£ç›˜2 - å·²åŠ å¯†å·²é”å®š -->
                    <div class="flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50">
                      <div class="flex items-center gap-4">
                        <span class="text-4xl">ğŸ”’</span>
                        <div>
                          <div class="font-bold font-mono text-lg">E:\</div>
                          <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs font-semibold bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full">
                              ğŸ” å·²é”å®š
                            </span>
                            <span class="text-xs text-gray-500">å®¹é‡: 1 TB</span>
                          </div>
                        </div>
                      </div>
                      <div class="flex gap-2">
                        <button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                          ğŸ”“ è§£é”
                        </button>
                        <button class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">
                          ğŸ”‘ æ”¹å¯†ç 
                        </button>
                      </div>
                    </div>

                    <!-- ç¤ºä¾‹ç£ç›˜3 - æœªåŠ å¯† -->
                    <div class="flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50">
                      <div class="flex items-center gap-4">
                        <span class="text-4xl">ğŸ’¾</span>
                        <div>
                          <div class="font-bold font-mono text-lg">F:\</div>
                          <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs text-gray-500">æœªåŠ å¯†</span>
                            <span class="text-xs text-gray-500">å®¹é‡: 500 GB</span>
                          </div>
                        </div>
                      </div>
                      <div class="flex gap-2">
                        <button class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                          ğŸ” å¯ç”¨åŠ å¯†
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- åŠ å¯†ç»Ÿè®¡ -->
                <div class="grid grid-cols-3 gap-4">
                  <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4 rounded-lg shadow">
                    <div class="text-sm opacity-90 mb-1">æ€»ç£ç›˜æ•°</div>
                    <div class="text-3xl font-bold">3</div>
                  </div>
                  <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-4 rounded-lg shadow">
                    <div class="text-sm opacity-90 mb-1">å·²åŠ å¯†</div>
                    <div class="text-3xl font-bold">2</div>
                  </div>
                  <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 text-white p-4 rounded-lg shadow">
                    <div class="text-sm opacity-90 mb-1">å·²è§£é”</div>
                    <div class="text-3xl font-bold">1</div>
                  </div>
                </div>
              </div>

              <!-- æ–‡ä»¶åŠ å¯†æ ‡ç­¾é¡µ -->
              <div v-if="window.encryptionTab === 'file'" class="space-y-4">
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                  <div class="flex items-start gap-3">
                    <span class="text-2xl">ğŸ’¡</span>
                    <div>
                      <h4 class="font-semibold text-blue-900 mb-1">ç‹¬ç«‹æ–‡ä»¶åŠ å¯†</h4>
                      <p class="text-sm text-blue-800">
                        ä¸ºå•ä¸ªæ–‡ä»¶æˆ–æ–‡ä»¶å¤¹è®¾ç½®ç‹¬ç«‹å¯†ç ã€‚åŠ å¯†åæ–‡ä»¶åä¼šæ·»åŠ  .encrypted åç¼€ã€‚
                        æ¯ä¸ªæ–‡ä»¶å¯ä»¥ä½¿ç”¨ä¸åŒçš„å¯†ç ,äº’ä¸å¹²æ‰°ã€‚
                      </p>
                    </div>
                  </div>
                </div>

                <!-- åŠ å¯†æ–°æ–‡ä»¶ -->
                <div class="bg-white rounded-lg shadow border p-6">
                  <h4 class="font-bold text-lg mb-4">åŠ å¯†æ–‡ä»¶/æ–‡ä»¶å¤¹</h4>

                  <div class="space-y-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©è¦åŠ å¯†çš„å†…å®¹</label>
                      <div class="flex gap-2">
                        <input type="text"
                               placeholder="è¯·è¾“å…¥æ–‡ä»¶è·¯å¾„æˆ–ç‚¹å‡»æµè§ˆé€‰æ‹©"
                               class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        <button class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                          ğŸ“ æµè§ˆ
                        </button>
                      </div>
                    </div>

                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">è®¾ç½®åŠ å¯†å¯†ç </label>
                      <input type="password"
                             placeholder="è¾“å…¥åŠ å¯†å¯†ç "
                             class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>

                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">ç¡®è®¤å¯†ç </label>
                      <input type="password"
                             placeholder="å†æ¬¡è¾“å…¥å¯†ç "
                             class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>

                    <button class="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600">
                      ğŸ” å¼€å§‹åŠ å¯†
                    </button>
                  </div>
                </div>

                <!-- è§£å¯†æ–‡ä»¶ -->
                <div class="bg-white rounded-lg shadow border p-6">
                  <h4 class="font-bold text-lg mb-4">è§£å¯†æ–‡ä»¶/æ–‡ä»¶å¤¹</h4>

                  <div class="space-y-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©åŠ å¯†çš„æ–‡ä»¶</label>
                      <div class="flex gap-2">
                        <input type="text"
                               placeholder="è¯·é€‰æ‹© .encrypted æ–‡ä»¶"
                               class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 outline-none">
                        <button class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                          ğŸ“ æµè§ˆ
                        </button>
                      </div>
                    </div>

                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">è¾“å…¥è§£å¯†å¯†ç </label>
                      <input type="password"
                             placeholder="è¾“å…¥åŸå¯†ç "
                             class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 outline-none">
                    </div>

                    <button class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600">
                      ğŸ”“ å¼€å§‹è§£å¯†
                    </button>
                  </div>
                </div>

                <!-- åŠ å¯†æ–‡ä»¶åˆ—è¡¨ç¤ºä¾‹ -->
                <div class="bg-white rounded-lg shadow border p-6">
                  <h4 class="font-bold text-lg mb-4">æœ€è¿‘åŠ å¯†çš„æ–‡ä»¶</h4>
                  <div class="space-y-2">
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                      <div class="flex items-center gap-3">
                        <span class="text-2xl">ğŸ”’</span>
                        <div>
                          <div class="font-semibold">è´¢åŠ¡æŠ¥è¡¨.xlsx.encrypted</div>
                          <div class="text-xs text-gray-500">åŠ å¯†æ—¶é—´: 2025-10-17 14:30</div>
                        </div>
                      </div>
                      <button class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600">
                        è§£å¯†
                      </button>
                    </div>

                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                      <div class="flex items-center gap-3">
                        <span class="text-2xl">ğŸ”’</span>
                        <div>
                          <div class="font-semibold">æœºå¯†æ–‡ä»¶.pdf.encrypted</div>
                          <div class="text-xs text-gray-500">åŠ å¯†æ—¶é—´: 2025-10-16 09:15</div>
                        </div>
                      </div>
                      <button class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600">
                        è§£å¯†
                      </button>
                    </div>
                  </div>
                </div>

                <!-- å®‰å…¨æç¤º -->
                <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                  <div class="flex items-start gap-3">
                    <span class="text-2xl">âš ï¸</span>
                    <div class="text-sm text-red-800">
                      <p class="font-semibold mb-1">é‡è¦å®‰å…¨æç¤º:</p>
                      <ul class="list-disc list-inside space-y-1">
                        <li>è¯·åŠ¡å¿…è®°ä½åŠ å¯†å¯†ç ,å¿˜è®°å¯†ç å°†æ°¸ä¹…æ— æ³•æ¢å¤æ–‡ä»¶</li>
                        <li>å»ºè®®ä½¿ç”¨å¼ºå¯†ç (è‡³å°‘8ä½,åŒ…å«å­—æ¯æ•°å­—ç¬¦å·)</li>
                        <li>ä¸è¦åœ¨ä¸å®‰å…¨çš„ç¯å¢ƒä¸‹è¾“å…¥å¯†ç </li>
                        <li>å®šæœŸå¤‡ä»½é‡è¦çš„åŠ å¯†æ–‡ä»¶</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ç³»ç»Ÿç›‘æ§çª—å£ -->
<div v-if="window.type === 'system-monitor'" class="h-full flex flex-col">
  <div v-if="window.monitorView === 'overview'" class="h-full flex flex-col">
    <div class="px-6 py-4 border-b bg-gradient-to-r from-green-50 to-teal-50">
      <h3 class="text-xl font-bold flex items-center gap-2">
        <span class="text-3xl">ğŸ“Š</span>
        ç³»ç»Ÿç›‘æ§æ€»è§ˆ
      </h3>
      <p class="text-sm text-gray-600 mt-1">é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</p>
    </div>
    <div class="flex-1 overflow-auto p-6 bg-gray-50">
      <div v-if="window.loading" class="flex justify-center items-center h-full">
        <div class="loading"></div> <span class="ml-2 text-gray-600">æ­£åœ¨åŠ è½½èŠ‚ç‚¹...</span>
      </div>
      <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div v-for="node in window.nodes" :key="node.id"
             @click="selectNodeForMonitor(window, node)"
             class="bg-white rounded-lg shadow border p-6 cursor-pointer hover:border-blue-500 hover:shadow-lg transition">
          <div class="flex justify-between items-start">
            <h4 class="font-bold text-lg mb-4 text-gray-800">{{ node.name }}</h4>
            <span class="text-3xl">ğŸ–¥ï¸</span>
          </div>
          <div class="space-y-4">
            <div>
              <div class="text-xs text-gray-600 mb-1">ç£ç›˜å®¹é‡</div>
              <div class="w-full bg-gray-200 rounded-full h-4">
                <div class="h-4 rounded-full flex items-center justify-center text-xs font-semibold"
                     :class="node.disk_usage > 80 ? 'bg-red-500 text-white' : 'bg-blue-500 text-white'"
                     :style="{ width: node.disk_usage + '%' }">
                  {{ node.disk_usage.toFixed(1) }}%
                </div>
              </div>
              <div class="text-xs text-gray-600 mt-1 text-right">
                {{ node.used_storage }} / {{ node.total_storage }} GB
              </div>
            </div>
            <div>
              <div class="text-xs text-gray-600 mb-1">CPU æ¸©åº¦</div>
              <div class="flex items-center gap-2">
                <span class="text-2xl">ğŸŒ¡ï¸</span>
                <span class="text-3xl font-bold"
                      :class="node.cpu_temp > 75 ? 'text-red-600' : 'text-orange-500'">
                  {{ node.cpu_temp.toFixed(1) }}Â°C
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div v-else-if="window.monitorView === 'detail'" class="h-full flex flex-col">
  <div class="px-6 py-4 border-b bg-gradient-to-r from-green-50 to-teal-50 flex justify-between items-center">
    <div>
      <h3 class="text-xl font-bold flex items-center gap-2">
        <span class="text-3xl">ğŸ–¥ï¸</span>
        {{ window.title }}
      </h3>
      <p class="text-sm text-gray-600 mt-1">å®æ—¶ç›‘æ§ç³»ç»Ÿç¡¬ä»¶çŠ¶æ€</p>
    </div>
    <button @click="returnToMonitorOverview(window)" class="px-4 py-2 bg-white border rounded-lg hover:bg-gray-50 transition">
      &lt; è¿”å›æ€»è§ˆ
    </button>
  </div>
  <div v-if="window.loading" class="flex-1 flex justify-center items-center">
      <div class="loading"></div> <span class="ml-2 text-gray-600">æ­£åœ¨åŠ è½½è¯¦ç»†æ•°æ®...</span>
  </div>
  <div v-else-if="window.selectedNodeStats" class="flex-1 overflow-auto p-6 bg-gray-50">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white rounded-lg shadow border p-4">
        <h4 class="font-semibold mb-4 text-lg flex items-center gap-2">
            <span class="text-2xl">ğŸŒ¡ï¸</span> æ¸©åº¦ç›‘æ§
        </h4>
        <div class="space-y-3">
          <div v-for="temp in window.selectedNodeStats.temperatures" class="flex justify-between items-center">
            <span class="text-gray-700">{{ temp.name }}</span>
            <span class="font-bold text-xl" :class="temp.value > 80 ? 'text-red-600' : 'text-orange-500'">
              {{ temp.value?.toFixed(1) || 'N/A' }}Â°C
            </span>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-lg shadow border p-4">
        <h4 class="font-semibold mb-4 text-lg flex items-center gap-2">
            <span class="text-2xl">ğŸ’¨</span> é£æ‰‡è½¬é€Ÿ
        </h4>
        <div class="space-y-3">
          <div v-for="fan in window.selectedNodeStats.fans" class="flex justify-between items-center">
            <span class="text-gray-700">{{ fan.name }}</span>
            <span class="font-bold text-xl text-blue-600">
              {{ fan.value?.toFixed(0) || 'N/A' }} RPM
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

        </div>
      </div>

      <div class="taskbar">
        <div class="taskbar-item" @click.stop="toggleStartMenu">
  <span class="text-xl">ğŸš€</span>
  <span class="ml-2 font-semibold">NAS Center</span>
</div>

        <div v-for="window in windows.filter(w => !w.minimized)"
             :key="window.id"
             @click="focusWindow(window.id)"
             :class="['taskbar-item', { active: window.zIndex === maxZIndex }]">
          <span>{{ window.icon }}</span>
          <span class="ml-2">{{ window.title }}</span>
        </div>

        <div class="ml-auto flex items-center gap-4 text-white text-sm">
          <span>â° {{ currentTime }}</span>
        </div>
      </div>

       <!-- ğŸ‘‡ åœ¨è¿™é‡Œæ·»åŠ å¼€å§‹èœå• -->
      <div v-if="showStartMenu" class="start-menu">
        <div class="start-menu-header">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-xl font-bold">NAS Center</div>
              <div class="text-sm opacity-90 mt-1">ä¸»æ§ç®¡ç†ä¸­å¿ƒ</div>
            </div>
            <div class="text-3xl">ğŸš€</div>
          </div>
        </div>

        <div class="start-menu-section">
          <div class="start-menu-section-title">å¿«é€Ÿè®¿é—®</div>
          <div class="start-menu-item" @click="openNodeManagement; showStartMenu = false">
            <span class="text-xl">ğŸ–¥ï¸</span>
            <div class="flex-1">
              <div class="font-semibold">èŠ‚ç‚¹ç®¡ç†</div>
              <div class="text-xs opacity-70">ç®¡ç†æ‰€æœ‰NASèŠ‚ç‚¹</div>
            </div>
          </div>
          <div class="start-menu-item" @click="openSystemMonitor; showStartMenu = false">
            <span class="text-xl">ğŸ“Š</span>
            <div class="flex-1">
              <div class="font-semibold">ç³»ç»Ÿç›‘æ§</div>
              <div class="text-xs opacity-70">å®æ—¶ç¡¬ä»¶ç›‘æ§</div>
            </div>
          </div>
          <div class="start-menu-item" @click="openSpaceAllocation; showStartMenu = false">
            <span class="text-xl">ğŸ“¦</span>
            <div class="flex-1">
              <div class="font-semibold">ç©ºé—´åˆ†é…</div>
              <div class="text-xs opacity-70">è·¨èŠ‚ç‚¹æ–‡ä»¶åˆ†é…</div>
            </div>
          </div>
        </div>

        <div class="h-px bg-white/10 my-2"></div>

        <div class="start-menu-section">
          <div class="start-menu-section-title">å®‰å…¨ç®¡ç†</div>
          <div class="start-menu-item" @click="openEncryptionManager; showStartMenu = false">
            <span class="text-xl">ğŸ”</span>
            <div class="flex-1">
              <div class="font-semibold">åŠ å¯†ç®¡ç†</div>
              <div class="text-xs opacity-70">ç£ç›˜å’Œæ–‡ä»¶åŠ å¯†</div>
            </div>
          </div>
          <div class="start-menu-item" @click="openPermissionSettings; showStartMenu = false">
            <span class="text-xl">ğŸ”’</span>
            <div class="flex-1">
              <div class="font-semibold">æƒé™è®¾ç½®</div>
              <div class="text-xs opacity-70">ç”¨æˆ·è®¿é—®æ§åˆ¶</div>
            </div>
          </div>
        </div>

        <div class="h-px bg-white/10 my-2"></div>

        <div class="start-menu-section">
          <div class="start-menu-section-title">é«˜çº§åŠŸèƒ½</div>
          <div class="start-menu-item" @click="openECConfig; showStartMenu = false">
            <span class="text-xl">ğŸ›¡ï¸</span>
            <div class="flex-1">
              <div class="font-semibold">çº åˆ ç é…ç½®</div>
              <div class="text-xs opacity-70">æ•°æ®å†—ä½™ä¿æŠ¤</div>
            </div>
          </div>
          <div class="start-menu-item start-menu-item-disabled">
            <span class="text-xl">ğŸ“¡</span>
            <div class="flex-1">
              <div class="font-semibold">è¿œç¨‹åŒæ­¥</div>
              <div class="text-xs opacity-70">å³å°†æ¨å‡º</div>
            </div>
          </div>
        </div>

        <div class="h-px bg-white/10 my-2"></div>

        <div class="start-menu-section">
          <div class="start-menu-item" @click="showStartMenu = false">
            <span class="text-xl">â„¹ï¸</span>
            <span>å…³äºç³»ç»Ÿ</span>
          </div>
          <div class="start-menu-item" @click="showStartMenu = false">
            <span class="text-xl">â“</span>
            <span>å¸®åŠ©æ–‡æ¡£</span>
          </div>
        </div>
      </div>
    </div>
  </div>





  <script>


    axios.defaults.withCredentials = true;
const { createApp } = Vue;

createApp({
  data() {
    return {
      windows: [],
      nextWindowId: 1,
      maxZIndex: 100,
      currentTime: '',
      dragWindow: null,
      dragOffset: { x: 0, y: 0 },
      apiBaseUrl: 'http://127.0.0.1:8080',
      showStartMenu: false,
      showNavbar: false,
      currentNodeName: 'NAS Center ä¸»æ§',
      currentUser: 'Guest'
    };
  },
  mounted() {
    this.updateTime();
    setInterval(() => this.updateTime(), 1000);
    this.checkAuth();
    this.openNodeManagement();
  },
  methods: {
    async checkAuth() {
      try {
        const response = await axios.get(`${this.apiBaseUrl}/api/check-auth`, {
          withCredentials: true
        });
        if (response.data.authenticated) {
          this.currentUser = response.data.user.username;
        } else {
          // æœªç™»å½•,è·³è½¬åˆ°ç™»å½•é¡µ
          window.location.href = '/';
        }
      } catch (error) {
        console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
        // æœªç™»å½•,è·³è½¬åˆ°ç™»å½•é¡µ
        window.location.href = '/';
      }
    },

    async logout() {
      if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—?')) {
        try {
          await axios.post(`${this.apiBaseUrl}/api/logout`, {}, {
            withCredentials: true
          });
          alert('å·²é€€å‡ºç™»å½•');
          window.location.href = '/';
        } catch (error) {
          console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
          alert('é€€å‡ºç™»å½•å¤±è´¥');
        }
      }
    },

    updateTime() {
      const now = new Date();
      this.currentTime = now.toLocaleTimeString('zh-CN');
    },

    createWindow(config) {
      const win = {
        id: this.nextWindowId++,
        x: 100 + (this.windows.length * 30),
        y: 50 + (this.windows.length * 30),
        width: config.width || 900,
        height: config.height || 600,
        zIndex: this.maxZIndex++,
        maximized: false,
        minimized: false,
        ...config
      };
      this.windows.push(win);
      return win;
    },

    closeWindow(id) {
      const index = this.windows.findIndex(w => w.id === id);
      if (index !== -1) {
        this.windows.splice(index, 1);
      }
    },

    minimizeWindow(id) {
      const win = this.windows.find(w => w.id === id);
      if (win) win.minimized = true;
    },

    toggleMaximize(id) {
      const win = this.windows.find(w => w.id === id);
      if (win) win.maximized = !win.maximized;
    },

    focusWindow(id) {
      const win = this.windows.find(w => w.id === id);
      if (win) {
        win.minimized = false;
        win.zIndex = this.maxZIndex++;
      }
    },

    startDrag(event, window) {
      if (window.maximized) return;
      this.dragWindow = window;
      this.dragOffset.x = event.clientX - window.x;
      this.dragOffset.y = event.clientY - window.y;

      document.addEventListener('mousemove', this.onDrag);
      document.addEventListener('mouseup', this.stopDrag);
    },

    onDrag(event) {
      if (!this.dragWindow) return;
      this.dragWindow.x = event.clientX - this.dragOffset.x;
      this.dragWindow.y = event.clientY - this.dragOffset.y;
    },

    stopDrag() {
      this.dragWindow = null;
      document.removeEventListener('mousemove', this.onDrag);
      document.removeEventListener('mouseup', this.stopDrag);
    },

    closeAllMenus() {
      this.showStartMenu = false;
    },

    // ============ èŠ‚ç‚¹ç®¡ç† ============
    openNodeManagement() {
      const win = this.createWindow({
        type: 'nodes',
        title: 'èŠ‚ç‚¹ç®¡ç†',
        icon: 'ğŸ–¥ï¸',
        width: 1200,
        height: 700,
        nodes: [],
        stats: null,
        loading: false,
        selectedNodeDisks: null
      });
      this.loadNodesData(win);
    },

    async loadNodesData(window) {
      window.loading = true;
      try {
        const nodesRes = await axios.get(`${this.apiBaseUrl}/api/nodes`);
        window.nodes = nodesRes.data;
        const statsRes = await axios.get(`${this.apiBaseUrl}/api/stats`);
        window.stats = {
          total: statsRes.data.total_nodes,
          online: statsRes.data.online_nodes,
          offline: statsRes.data.offline_nodes,
          warning: statsRes.data.warning_nodes
        };
      } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error);
        alert('æ— æ³•è¿æ¥åˆ°åç«¯ API,è¯·ç¡®ä¿ Flask æœåŠ¡è¿è¡Œåœ¨ http://127.0.0.1:8080');
      } finally {
        window.loading = false;
      }
    },

    refreshNodes(window) {
      this.loadNodesData(window);
    },

    accessNode(node) {
      const url = `http://${node.ip}:${node.port}`;

      if (node.status === 'offline') {
        alert(`èŠ‚ç‚¹ ${node.name} å½“å‰ç¦»çº¿,æ— æ³•è®¿é—®`);
        return;
      }

      const confirmed = confirm(
        `è®¿é—®èŠ‚ç‚¹åå°†åœ¨æ–°çª—å£æ‰“å¼€\né¡¶éƒ¨å¯¼èˆªæ å¯å¸®åŠ©æ‚¨è¿”å›ä¸»æ§ä¸­å¿ƒ\n\n` +
        `èŠ‚ç‚¹åç§°: ${node.name}\n` +
        `è®¿é—®åœ°å€: ${url}\n\n` +
        `æ˜¯å¦ç»§ç»­?`
      );

      if (confirmed) {
        // æ˜¾ç¤ºå¯¼èˆªæ 
        this.showNavbar = true;
        this.currentNodeName = node.name;

        // åœ¨æ–°çª—å£æ‰“å¼€
        window.open(url, '_blank');
      }
    },

    async viewNodeDisks(window, node) {
      if (node.status === 'offline') {
        alert(`èŠ‚ç‚¹ ${node.name} å½“å‰ç¦»çº¿,æ— æ³•æŸ¥çœ‹ç£ç›˜ä¿¡æ¯`);
        return;
      }

      window.selectedNodeDisks = {
        name: node.name,
        loading: true,
        error: null,
        disks: []
      };

      try {
        const response = await axios.get(`${this.apiBaseUrl}/api/nodes/${node.id}/disks`);

        if (response.data.success) {
          window.selectedNodeDisks.disks = response.data.disks;
          window.selectedNodeDisks.loading = false;
        } else {
          throw new Error(response.data.error || 'è·å–ç£ç›˜ä¿¡æ¯å¤±è´¥');
        }
      } catch (error) {
        console.error('è·å–ç£ç›˜ä¿¡æ¯å¤±è´¥:', error);
        window.selectedNodeDisks.error = error.response?.data?.error || error.message || 'æ— æ³•è¿æ¥åˆ°èŠ‚ç‚¹';
        window.selectedNodeDisks.loading = false;
      }
    },

    getStatusClass(status) {
      const classes = {
        online: 'bg-green-100 text-green-700 border border-green-300',
        offline: 'bg-gray-100 text-gray-700 border border-gray-300',
        warning: 'bg-yellow-100 text-yellow-700 border border-yellow-300'
      };
      return classes[status] || classes.offline;
    },

    getStatusText(status) {
      const texts = { online: 'åœ¨çº¿', offline: 'ç¦»çº¿', warning: 'æœªçŸ¥' };
      return texts[status] || 'æœªçŸ¥';
    },

    // ============ ç©ºé—´åˆ†é… ============
    openSpaceAllocation() {
      this.createWindow({
        type: 'space-allocation',
        title: 'ç©ºé—´åˆ†é…',
        icon: 'ğŸ“¦',
        width: 1000,
        height: 700
      });
    },

    // ============ æƒé™è®¾ç½® ============
    openPermissionSettings() {
      this.createWindow({
        type: 'permissions',
        title: 'æƒé™ç®¡ç†',
        icon: 'ğŸ”’',
        width: 1200,
        height: 750,

        // æ–°å¢å­—æ®µ
        permissionTab: 'users',  // æ ‡ç­¾é¡µ: users/node-groups/node-access/audit
        users: [],
        nodeGroups: [],
        nodes: [],
        auditLogs: [],

        // ç”¨æˆ·ç®¡ç†ç›¸å…³
        showUserDialog: false,
        editingUser: null,
        userForm: {
          username: '',
          password: '',
          email: '',
          role: 'user'
        },

        // åˆ†ç»„ç®¡ç†ç›¸å…³
        showGroupDialog: false,
        editingGroup: null,
        groupForm: {
          group_name: '',
          description: '',
          node_ids: [],
          color: '#3b82f6',
          icon: 'ğŸ“'
        },

        // æƒé™é…ç½®ç›¸å…³
        selectedUserId: null,
        accessForm: {
          type: 'group_based',
          allowed_groups: [],
          allowed_nodes: [],
          denied_nodes: []
        }
      });

      // åŠ è½½æ•°æ®
      this.loadPermissionData(this.windows[this.windows.length - 1]);
    },

    async loadPermissionData(window) {
      // å¹¶è¡ŒåŠ è½½ä¸‰ä¸ªæ¥å£
      const [usersRes, groupsRes, nodesRes] = await Promise.all([
        axios.get(`${this.apiBaseUrl}/api/users`),
        axios.get(`${this.apiBaseUrl}/api/node-groups`),
        axios.get(`${this.apiBaseUrl}/api/nodes`)
      ]);

      window.users = usersRes.data;
      window.groups = groupsRes.data.map(group => ({
    ...group,
    nodes: group.node_ids || []  // æŠŠ node_ids æ˜ å°„ä¸º nodes
}));
      window.nodes = nodesRes.data;
    },

    async createUser(window) {
      await axios.post(`${this.apiBaseUrl}/api/users`, window.userForm);
      alert('ç”¨æˆ·åˆ›å»ºæˆåŠŸ');
      window.showUserDialog = false;
      this.loadPermissionData(window);
      // âœ… æ­£ç¡®çš„é‡ç½®æ–¹å¼
      window.userForm = {
        username: '',
        password: '',
        email: '',
        role: 'user'
      };
    },

    async updateUser(window, userId) {
      // å®ç°ç¼–è¾‘ç”¨æˆ·åŠŸèƒ½
      await axios.put(`${this.apiBaseUrl}/api/users/${userId}`, window.userForm);
      alert('ç”¨æˆ·æ›´æ–°æˆåŠŸ');
      window.showUserDialog = false;
      this.loadPermissionData(window);
    },

    async updateNodeGroup(window, groupId) { /* PUT */ },

    async deleteUser(window, userId) {
      if (confirm('ç¡®è®¤åˆ é™¤è¯¥ç”¨æˆ·?')) {
        await axios.delete(`${this.apiBaseUrl}/api/users/${userId}`);
        alert('ç”¨æˆ·å·²åˆ é™¤');
        this.loadPermissionData(window);
      }
    },

    async createNodeGroup(window) {
      await axios.post(`${this.apiBaseUrl}/api/node-groups`, window.groupForm);
      alert('åˆ†ç»„åˆ›å»ºæˆåŠŸ');
      window.showGroupDialog = false;
      this.loadPermissionData(window);
    },

    async deleteNodeGroup(window, groupId) {
      if (confirm('ç¡®è®¤åˆ é™¤è¯¥åˆ†ç»„?')) {
        await axios.delete(`${this.apiBaseUrl}/api/node-groups/${groupId}`);
        alert('åˆ†ç»„å·²åˆ é™¤');
        this.loadPermissionData(window);
      }
    },

    // è¾…åŠ©æ–¹æ³•
    getNodeName(window, nodeId) {
      const node = window.nodes.find(n => n.id === nodeId);
      return node ? node.name : nodeId;
    },

    editNodeGroup(window, group) {
      window.editingGroup = group;
      window.groupForm = { ...group, node_ids: [...group.node_ids] };
      window.showGroupDialog = true;
    },

    async loadUserNodeAccess(window, userId) {
      const res = await axios.get(`${this.apiBaseUrl}/api/users/${userId}/node-access`);
      window.accessForm = res.data;
      window.selectedUserId = userId;
    },

    async saveUserNodeAccess(window) {
      await axios.put(
        `${this.apiBaseUrl}/api/users/${window.selectedUserId}/node-access`,
        window.accessForm
      );
      alert('æƒé™å·²ä¿å­˜');
    },

    async loadAuditLogs(window, filters = {}) {
      const params = new URLSearchParams(filters);
      const res = await axios.get(`${this.apiBaseUrl}/api/audit-logs?${params}`);
      window.auditLogs = res.data;
    },

    // ============ åŠ å¯†ç®¡ç† ============
    openEncryptionManager() {
      this.createWindow({
        type: 'encryption',
        title: 'åŠ å¯†ç®¡ç†',
        icon: 'ğŸ”',
        width: 1000,
        height: 700,
        encryptionTab: 'disk'  // é»˜è®¤æ˜¾ç¤ºç£ç›˜åŠ å¯†æ ‡ç­¾é¡µ
      });
    },

    // ============ çº åˆ ç é…ç½® ============
    openECConfig() {
    const existing = this.windows.find(w => w.type === 'ec-config');
    if (existing) {
        this.focusWindow(existing.id);
        this.showStartMenu = false;
        return;
    }

    const win = this.createWindow({
        type: 'ec-config',
        title: 'çº åˆ ç é…ç½®',
        icon: 'ğŸ›¡ï¸',
        width: 1000,
        height: 700,
        currentTab: 'config',
        ecConfig: null,
        capacity: null,
        availableDisks: [],
        selectedNodeId: null,  // ğŸ‘ˆ æ·»åŠ è¿™ä¸€è¡Œ
        nodes: [],             // ğŸ‘ˆ æ·»åŠ è¿™ä¸€è¡Œ
        policies: [],          // ğŸ‘ˆ æ·»åŠ è¿™ä¸€è¡Œ
        loading: true,

        configForm: {
            k: 4,
            m: 2,
            disks: []
        }
    });

    this.loadECConfig(win);
    this.showStartMenu = false;
},
    // ============ ç³»ç»Ÿç›‘æ§ ============
    openSystemMonitor() {
      const win = this.createWindow({
        type: 'system-monitor',
        title: 'ç³»ç»Ÿç›‘æ§',
        icon: 'ğŸ“Š',
        width: 1000,
        height: 700,
        // ğŸ‘‡ æ–°å¢çŠ¶æ€
        monitorView: 'overview', // 'overview' æˆ– 'detail'
        nodes: [],
        selectedNodeId: null,
        selectedNodeStats: null,
        loading: true,
      });
      this.loadMonitorOverview(win); // è°ƒç”¨æ–°çš„åŠ è½½å‡½æ•°
      this.showStartMenu = false;
    },

    async loadMonitorOverview(window) {
      window.loading = true;
      try {
        const res = await axios.get(`${this.apiBaseUrl}/api/nodes`);
        // åªæ˜¾ç¤ºåœ¨çº¿çš„èŠ‚ç‚¹
        window.nodes = res.data.filter(n => n.status === 'online');
      } catch (error) {
        console.error('åŠ è½½ç›‘æ§èŠ‚ç‚¹åˆ—è¡¨å¤±è´¥:', error);
        alert('åŠ è½½ç›‘æ§èŠ‚ç‚¹åˆ—è¡¨å¤±è´¥');
      } finally {
        window.loading = false;
      }
    },

    async selectNodeForMonitor(window, node) {
      window.loading = true;
      window.selectedNodeId = node.id;
      window.title = `ç³»ç»Ÿç›‘æ§ - ${node.name}`; // åŠ¨æ€æ”¹å˜çª—å£æ ‡é¢˜
      try {
        const res = await axios.get(`${this.apiBaseUrl}/api/nodes/${node.id}/monitor-stats`);
        window.selectedNodeStats = res.data;
        window.monitorView = 'detail'; // åˆ‡æ¢åˆ°è¯¦æƒ…è§†å›¾
      } catch (error) {
        console.error('åŠ è½½èŠ‚ç‚¹è¯¦ç»†ç›‘æ§æ•°æ®å¤±è´¥:', error);
        alert('åŠ è½½èŠ‚ç‚¹è¯¦ç»†ç›‘æ§æ•°æ®å¤±è´¥');
        window.selectedNodeId = null;
      } finally {
        window.loading = false;
      }
    },

    returnToMonitorOverview(window) {
      window.monitorView = 'overview';
      window.selectedNodeId = null;
      window.selectedNodeStats = null;
      window.title = 'ç³»ç»Ÿç›‘æ§'; // æ¢å¤çª—å£æ ‡é¢˜
    },

    toggleStartMenu() {
      this.showStartMenu = !this.showStartMenu;
    },

    returnToMainCenter() {
      this.showNavbar = false;
      this.currentNodeName = 'NAS Center ä¸»æ§';
      alert('å·²è¿”å›ä¸»æ§ä¸­å¿ƒ');
    },

    refreshCurrentNode() {
      alert(`åˆ·æ–°èŠ‚ç‚¹: ${this.currentNodeName}`);
    }
  }
}).mount('#app');
</script>

</body>
</html>
